<!DOCTYPE html>
<html>
<head>
<title>Data.Regexp.hs</title>
<!-- 2018-01-16 Tue 13:43 -->
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<link rel="stylesheet" type="text/css" href="/css/prelude.css" />
<link rel="stylesheet" type="text/css" href="/css/highlight.css" />
</head>
<body>
<div id="content">
<h1 class="title">Data.Regexp.hs</h1>
<p>
勉強のために簡単な DFA 型の正規表現エンジン実装してみた．
パフォーマンスなどの問題から実用には程遠いものの， 基本的な機能はひととおり揃えている．
</p>

<p>
基本的な使い方は簡単．
</p>

<pre class="example">
-- /.*\.hs/ という正規表現
let pat = convertRegexpToDFA (many any &gt;&gt;&gt; string ".hs")
pat =~ "hello.hs" -- True
pat =~ "hello.sml" -- False
</pre>

<p>
正規表現の否定もできる．
</p>

<pre class="example">
-- /.*\.hs/ という正規表現
let pat = convertRegexpToDFA (not (char 'a'))
pat =~ "a" -- False
pat =~ "b" -- True
pat =~ "abc" -- True
-- これは直観に反するかもしれないが，
-- "a" の否定は "a" を含まない文字列ではなく
-- "a" 以外のすべての文字列である
</pre>

<div class="highlight"><pre><span class="c1">-- Data.Regexp.hs © 2018 Kaoru Kawamukai &lt;bydriv@gmail.com&gt;</span>
<span class="c1">--</span>
<span class="c1">-- Data.Regexp.hs is free software: you can redistribute it and/or modify</span>
<span class="c1">-- it under the terms of the GNU General Public License as published by</span>
<span class="c1">-- the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">-- (at your option) any later version.</span>
<span class="c1">--</span>
<span class="c1">-- Data.Regexp.hs is distributed in the hope that it will be useful,</span>
<span class="c1">-- but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">-- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">-- GNU General Public License for more details.</span>
<span class="c1">--</span>
<span class="c1">-- You should have received a copy of the GNU General Public License</span>
<span class="c1">-- along with Data.Regexp.hs.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kr">module</span> <span class="nn">Data.Regexp</span>
  <span class="p">(</span> <span class="kt">Regexp</span>
  <span class="p">,</span> <span class="nf">empty</span>
  <span class="p">,</span> <span class="nf">epsilon</span>
  <span class="p">,</span> <span class="nf">to</span>
  <span class="p">,</span> <span class="nf">generalCategory</span>
  <span class="p">,</span> <span class="p">(</span><span class="o">&gt;&gt;&gt;</span><span class="p">)</span>
  <span class="p">,</span> <span class="p">(</span><span class="o">|||</span><span class="p">)</span>
  <span class="p">,</span> <span class="nf">many</span>
  <span class="p">,</span> <span class="nf">some</span>
  <span class="p">,</span> <span class="nf">optional</span>
  <span class="p">,</span> <span class="nf">any</span>
  <span class="p">,</span> <span class="nf">char</span>
  <span class="p">,</span> <span class="nf">string</span>
  <span class="p">,</span> <span class="nf">oneOf</span>
  <span class="p">,</span> <span class="nf">noneOf</span>
  <span class="p">,</span> <span class="nf">not</span>
  <span class="p">,</span> <span class="p">(</span><span class="o">&amp;&amp;&amp;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nf">diff</span>
  <span class="p">,</span> <span class="nf">xor</span>
  <span class="p">,</span> <span class="nf">convertRegexpToDFA</span>
  <span class="p">,</span> <span class="nf">fillTable</span>
  <span class="p">,</span> <span class="nf">minimize</span>
  <span class="p">,</span> <span class="nf">convertDFAToRegexp</span>
  <span class="p">,</span> <span class="nf">runDFAToRegexp</span> <span class="p">)</span> <span class="kr">where</span>

<span class="kr">import</span>           <span class="nn">Prelude</span>
  <span class="k">hiding</span> <span class="p">(</span><span class="nf">any</span><span class="p">,</span> <span class="nf">lex</span><span class="p">,</span> <span class="nf">not</span><span class="p">)</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Prelude</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Control.Monad</span>                <span class="k">as</span> <span class="n">Monad</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Control.Monad.State</span>          <span class="k">as</span> <span class="n">State</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Char</span>                    <span class="k">as</span> <span class="n">Char</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.List</span>                    <span class="k">as</span> <span class="n">List</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Maybe</span>                   <span class="k">as</span> <span class="n">Maybe</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.RBMap</span>                   <span class="k">as</span> <span class="n">RBMap</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.RBSet</span>                   <span class="k">as</span> <span class="n">RBSet</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Word</span>                    <span class="k">as</span> <span class="n">Word</span>

<span class="kr">infix</span> <span class="mi">5</span> <span class="p">`</span><span class="n">to</span><span class="p">`</span>
<span class="kr">infixr</span> <span class="mi">4</span> <span class="kt">:::</span><span class="p">,</span> <span class="o">&gt;&gt;&gt;</span>
<span class="kr">infixr</span> <span class="mi">3</span> <span class="o">&amp;&amp;&amp;</span>
<span class="kr">infixr</span> <span class="mi">2</span> <span class="kt">:|:</span><span class="p">,</span> <span class="o">|||</span>

<span class="kr">type</span> <span class="kt">Range</span> <span class="ow">=</span> <span class="p">(</span><span class="kt">Char</span><span class="p">,</span> <span class="kt">Char</span><span class="p">)</span>

<span class="kr">data</span> <span class="kt">Regexp</span> <span class="ow">=</span>
    <span class="kt">Empty</span>
  <span class="o">|</span> <span class="kt">Epsilon</span>
  <span class="o">|</span> <span class="kt">Ranges</span> <span class="p">[</span><span class="kt">Range</span><span class="p">]</span>
  <span class="o">|</span> <span class="kt">Regexp</span> <span class="kt">:::</span> <span class="kt">Regexp</span>
  <span class="o">|</span> <span class="kt">Regexp</span> <span class="kt">:|:</span> <span class="kt">Regexp</span>
  <span class="o">|</span> <span class="kt">Many</span> <span class="kt">Regexp</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">,</span> <span class="kt">Read</span><span class="p">,</span> <span class="kt">Show</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">NFAState</span> <span class="ow">=</span> <span class="kt">Word</span><span class="o">.</span><span class="kt">Word64</span>

<span class="kr">data</span> <span class="kt">NFALabel</span> <span class="ow">=</span>
    <span class="kt">NFAEpsilon</span>
  <span class="o">|</span> <span class="kt">NFARanges</span> <span class="p">[</span><span class="kt">Range</span><span class="p">]</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">,</span> <span class="kt">Read</span><span class="p">,</span> <span class="kt">Show</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">NFATransition</span> <span class="ow">=</span> <span class="kt">RBMap</span><span class="o">.</span><span class="kt">RBMap</span> <span class="p">(</span><span class="kt">NFAState</span><span class="p">,</span> <span class="kt">NFALabel</span><span class="p">)</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="kt">RBSet</span> <span class="kt">NFAState</span><span class="p">)</span>

<span class="kr">data</span> <span class="kt">NFA</span> <span class="ow">=</span> <span class="kt">NFA</span>
  <span class="p">{</span> <span class="n">nfaTransition</span> <span class="ow">::</span> <span class="kt">NFATransition</span>
  <span class="p">,</span> <span class="n">nfaInitialState</span> <span class="ow">::</span> <span class="kt">NFAState</span>
  <span class="p">,</span> <span class="n">nfaFinalStates</span> <span class="ow">::</span> <span class="kt">RBSet</span><span class="o">.</span><span class="kt">RBSet</span> <span class="kt">NFAState</span> <span class="p">}</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">,</span> <span class="kt">Read</span><span class="p">,</span> <span class="kt">Show</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">DFAState</span> <span class="ow">=</span> <span class="kt">Word</span><span class="o">.</span><span class="kt">Word64</span>

<span class="kr">data</span> <span class="kt">DFALabel</span> <span class="ow">=</span>
    <span class="kt">DFARanges</span> <span class="p">[</span><span class="kt">Range</span><span class="p">]</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">,</span> <span class="kt">Read</span><span class="p">,</span> <span class="kt">Show</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">DFATransition</span> <span class="ow">=</span> <span class="kt">RBMap</span><span class="o">.</span><span class="kt">RBMap</span> <span class="p">(</span><span class="kt">DFAState</span><span class="p">,</span> <span class="kt">DFALabel</span><span class="p">)</span> <span class="kt">DFAState</span>

<span class="kr">data</span> <span class="kt">DFA</span> <span class="ow">=</span> <span class="kt">DFA</span>
  <span class="p">{</span> <span class="n">dfaInitialState</span> <span class="ow">::</span> <span class="kt">DFAState</span>
  <span class="p">,</span> <span class="n">dfaFinalStates</span> <span class="ow">::</span> <span class="kt">RBSet</span><span class="o">.</span><span class="kt">RBSet</span> <span class="kt">DFAState</span>
  <span class="p">,</span> <span class="n">dfaTransition</span> <span class="ow">::</span> <span class="kt">DFATransition</span> <span class="p">}</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">,</span> <span class="kt">Read</span><span class="p">,</span> <span class="kt">Show</span><span class="p">)</span>

<span class="kr">data</span> <span class="kt">RegexpToNFAState</span> <span class="ow">=</span> <span class="kt">RegexpToNFAState</span>
  <span class="p">{</span> <span class="n">nfaFreshState</span> <span class="ow">::</span> <span class="kt">NFAState</span> <span class="p">}</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">,</span> <span class="kt">Read</span><span class="p">,</span> <span class="kt">Show</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">RegexpToNFA</span> <span class="ow">=</span> <span class="kt">State</span><span class="o">.</span><span class="kt">State</span> <span class="kt">RegexpToNFAState</span>

<span class="kr">data</span> <span class="kt">NFAToDFAState</span> <span class="ow">=</span> <span class="kt">NFAToDFAState</span>
  <span class="p">{</span> <span class="n">dfaStates</span> <span class="ow">::</span> <span class="kt">RBMap</span><span class="o">.</span><span class="kt">RBMap</span> <span class="kt">DFAState</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="kt">RBSet</span> <span class="kt">NFAState</span><span class="p">)</span>
  <span class="p">,</span> <span class="n">dfaFreshState</span> <span class="ow">::</span> <span class="kt">DFAState</span>
  <span class="p">,</span> <span class="n">dfaCurrentState</span> <span class="ow">::</span> <span class="kt">DFAState</span>
  <span class="p">,</span> <span class="n">dfaTrans</span> <span class="ow">::</span> <span class="kt">DFATransition</span> <span class="p">}</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">,</span> <span class="kt">Read</span><span class="p">,</span> <span class="kt">Show</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">NFAToDFA</span> <span class="ow">=</span> <span class="kt">State</span><span class="o">.</span><span class="kt">State</span> <span class="kt">NFAToDFAState</span>

<span class="kr">type</span> <span class="kt">DFAToRegexpState</span> <span class="ow">=</span>
  <span class="p">(</span><span class="kt">Word</span><span class="o">.</span><span class="kt">Word64</span><span class="p">,</span> <span class="kt">Word</span><span class="o">.</span><span class="kt">Word64</span><span class="p">,</span> <span class="kt">RBMap</span><span class="o">.</span><span class="kt">RBMap</span> <span class="p">(</span><span class="kt">Word</span><span class="o">.</span><span class="kt">Word64</span><span class="p">,</span> <span class="kt">Word</span><span class="o">.</span><span class="kt">Word64</span><span class="p">)</span> <span class="kt">Regexp</span><span class="p">,</span> <span class="kt">RBSet</span><span class="o">.</span><span class="kt">RBSet</span> <span class="kt">Word</span><span class="o">.</span><span class="kt">Word64</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">DFAToRegexp</span> <span class="ow">=</span> <span class="kt">State</span><span class="o">.</span><span class="kt">State</span> <span class="kt">DFAToRegexpState</span>

<span class="nf">nullRange</span> <span class="ow">::</span> <span class="kt">Range</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
<span class="nf">nullRange</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span>

<span class="nf">subsetRange</span> <span class="ow">::</span> <span class="kt">Range</span> <span class="ow">-&gt;</span> <span class="kt">Range</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
<span class="nf">subsetRange</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">(</span><span class="n">x&#39;</span><span class="p">,</span> <span class="n">y&#39;</span><span class="p">)</span> <span class="ow">=</span> <span class="n">x&#39;</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">y&#39;</span>

<span class="nf">empty</span> <span class="ow">::</span> <span class="kt">Regexp</span>
<span class="nf">empty</span> <span class="ow">=</span> <span class="kt">Empty</span>

<span class="nf">epsilon</span> <span class="ow">::</span> <span class="kt">Regexp</span>
<span class="nf">epsilon</span> <span class="ow">=</span> <span class="kt">Epsilon</span>

<span class="nf">to</span> <span class="ow">::</span> <span class="kt">Char</span> <span class="ow">-&gt;</span> <span class="kt">Char</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">c1</span> <span class="p">`</span><span class="n">to</span><span class="p">`</span> <span class="n">c2</span> <span class="ow">=</span> <span class="kt">Ranges</span> <span class="p">[(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)]</span>

<span class="nf">generalCategory</span> <span class="ow">::</span> <span class="kt">Char</span><span class="o">.</span><span class="kt">GeneralCategory</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">generalCategory</span> <span class="ow">=</span> <span class="n">maybe</span> <span class="kt">Empty</span> <span class="kt">Ranges</span> <span class="o">.</span> <span class="n">flip</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">lookup</span> <span class="n">generalCategoryInfo</span>

<span class="p">(</span><span class="o">&gt;&gt;&gt;</span><span class="p">)</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="p">(</span><span class="o">&gt;&gt;&gt;</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="kt">:::</span><span class="p">)</span>

<span class="p">(</span><span class="o">|||</span><span class="p">)</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="p">(</span><span class="o">|||</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="kt">:|:</span><span class="p">)</span>

<span class="nf">many</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">many</span> <span class="ow">=</span> <span class="kt">Many</span>

<span class="nf">some</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">some</span> <span class="n">regexp</span> <span class="ow">=</span> <span class="n">regexp</span> <span class="kt">:::</span> <span class="kt">Many</span> <span class="n">regexp</span>

<span class="nf">optional</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">optional</span> <span class="ow">=</span> <span class="p">(</span><span class="kt">:|:</span> <span class="kt">Epsilon</span><span class="p">)</span>

<span class="nf">any</span> <span class="ow">::</span> <span class="kt">Regexp</span>
<span class="nf">any</span> <span class="ow">=</span> <span class="kt">Ranges</span> <span class="p">[(</span><span class="n">minBound</span><span class="p">,</span> <span class="n">maxBound</span><span class="p">)]</span>

<span class="nf">char</span> <span class="ow">::</span> <span class="kt">Char</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">char</span> <span class="n">c</span> <span class="ow">=</span> <span class="kt">Ranges</span> <span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)]</span>

<span class="nf">string</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">string</span> <span class="ow">=</span> <span class="n">foldr</span> <span class="p">(</span><span class="kt">:::</span><span class="p">)</span> <span class="kt">Epsilon</span> <span class="o">.</span> <span class="n">map</span> <span class="n">char</span>

<span class="nf">oneOf</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Char</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">oneOf</span> <span class="ow">=</span> <span class="kt">Ranges</span> <span class="o">.</span> <span class="n">minimizeRanges</span> <span class="o">.</span> <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="o">.</span> <span class="kt">List</span><span class="o">.</span><span class="n">nub</span> <span class="o">.</span> <span class="kt">List</span><span class="o">.</span><span class="n">sort</span>
  <span class="kr">where</span>
    <span class="n">minimizeRanges</span> <span class="kt">[]</span> <span class="ow">=</span> <span class="kt">[]</span>
    <span class="n">minimizeRanges</span> <span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="ow">=</span> <span class="p">[</span><span class="n">r</span><span class="p">]</span>
    <span class="n">minimizeRanges</span> <span class="p">(</span><span class="n">r1</span> <span class="kt">:</span> <span class="n">r2</span> <span class="kt">:</span> <span class="n">rs</span><span class="p">)</span> <span class="ow">=</span>
      <span class="kr">let</span> <span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span> <span class="ow">=</span> <span class="n">r1</span> <span class="kr">in</span>
      <span class="kr">let</span> <span class="p">(</span><span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">)</span> <span class="ow">=</span> <span class="n">r2</span> <span class="kr">in</span>
        <span class="kr">if</span> <span class="n">c2</span> <span class="o">==</span> <span class="n">maxBound</span> <span class="kr">then</span>
          <span class="p">[(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)]</span>
        <span class="kr">else</span> <span class="kr">if</span> <span class="n">succ</span> <span class="n">c2</span> <span class="o">==</span> <span class="n">c3</span> <span class="kr">then</span>
          <span class="n">minimizeRanges</span> <span class="p">((</span><span class="n">c1</span><span class="p">,</span> <span class="n">c4</span><span class="p">)</span> <span class="kt">:</span> <span class="n">rs</span><span class="p">)</span>
        <span class="kr">else</span>
          <span class="n">r1</span> <span class="kt">:</span> <span class="n">minimizeRanges</span> <span class="p">(</span><span class="n">r2</span> <span class="kt">:</span> <span class="n">rs</span><span class="p">)</span>

<span class="nf">noneOf</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Char</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">noneOf</span> <span class="ow">=</span> <span class="n">diff</span> <span class="n">any</span> <span class="o">.</span> <span class="n">oneOf</span>

<span class="nf">not</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">not</span> <span class="ow">=</span> <span class="n">runDFAToRegexp</span> <span class="o">.</span> <span class="n">convertDFAToRegexp</span> <span class="o">.</span> <span class="n">complement</span> <span class="o">.</span> <span class="n">minimize</span> <span class="o">.</span>
  <span class="n">runNFAToDFA</span> <span class="o">.</span> <span class="n">convertNFAToDFA</span> <span class="o">.</span> <span class="n">runRegexpToNFA</span> <span class="o">.</span> <span class="n">convertRegexpToNFA</span>

<span class="p">(</span><span class="o">&amp;&amp;&amp;</span><span class="p">)</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">r1</span> <span class="o">&amp;&amp;&amp;</span> <span class="n">r2</span> <span class="ow">=</span> <span class="n">not</span> <span class="p">(</span><span class="n">not</span> <span class="n">r1</span> <span class="kt">:|:</span> <span class="n">not</span> <span class="n">r2</span><span class="p">)</span>

<span class="nf">diff</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">diff</span> <span class="n">r1</span> <span class="n">r2</span> <span class="ow">=</span> <span class="n">not</span> <span class="p">(</span><span class="n">not</span> <span class="n">r1</span> <span class="kt">:|:</span> <span class="n">r2</span><span class="p">)</span>

<span class="nf">xor</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
<span class="nf">xor</span> <span class="n">r1</span> <span class="n">r2</span> <span class="ow">=</span> <span class="p">(</span><span class="n">r1</span> <span class="kt">:|:</span> <span class="n">r2</span><span class="p">)</span> <span class="p">`</span><span class="n">diff</span><span class="p">`</span> <span class="p">(</span><span class="n">r1</span> <span class="o">&amp;&amp;&amp;</span> <span class="n">r2</span><span class="p">)</span>

<span class="nf">groupByGeneralCategory</span> <span class="ow">::</span> <span class="kt">Range</span> <span class="ow">-&gt;</span> <span class="p">[(</span><span class="kt">Char</span><span class="o">.</span><span class="kt">GeneralCategory</span><span class="p">,</span> <span class="kt">Range</span><span class="p">)]</span>
<span class="nf">groupByGeneralCategory</span> <span class="ow">=</span>
  <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">gcat</span><span class="p">,</span> <span class="n">cs</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">gcat</span><span class="p">,</span> <span class="p">(</span><span class="n">head</span> <span class="n">cs</span><span class="p">,</span> <span class="n">last</span> <span class="n">cs</span><span class="p">)))</span> <span class="o">.</span>
    <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="n">tmp</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">fst</span> <span class="p">(</span><span class="n">head</span> <span class="n">tmp</span><span class="p">),</span> <span class="n">map</span> <span class="n">snd</span> <span class="n">tmp</span><span class="p">))</span> <span class="o">.</span>
      <span class="kt">List</span><span class="o">.</span><span class="n">groupBy</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">gcat</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="p">(</span><span class="n">gcat&#39;</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">gcat</span> <span class="o">==</span> <span class="n">gcat&#39;</span><span class="p">)</span> <span class="o">.</span>
        <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Char</span><span class="o">.</span><span class="n">generalCategory</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="o">.</span>
          <span class="n">uncurry</span> <span class="n">enumFromTo</span>

<span class="nf">generalCategoryInfo</span> <span class="ow">::</span> <span class="kt">RBMap</span><span class="o">.</span><span class="kt">RBMap</span> <span class="kt">Char</span><span class="o">.</span><span class="kt">GeneralCategory</span> <span class="p">[</span><span class="kt">Range</span><span class="p">]</span>
<span class="nf">generalCategoryInfo</span> <span class="ow">=</span>
  <span class="kt">RBMap</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span>
    <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="n">tmp</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">fst</span> <span class="p">(</span><span class="n">head</span> <span class="n">tmp</span><span class="p">),</span> <span class="n">map</span> <span class="n">snd</span> <span class="n">tmp</span><span class="p">))</span> <span class="o">$</span>
      <span class="kt">List</span><span class="o">.</span><span class="n">groupBy</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">gcat</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="p">(</span><span class="n">gcat&#39;</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">gcat</span> <span class="o">==</span> <span class="n">gcat&#39;</span><span class="p">)</span> <span class="o">$</span>
        <span class="kt">List</span><span class="o">.</span><span class="n">sortBy</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">gcat</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="p">(</span><span class="n">gcat&#39;</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">compare</span> <span class="n">gcat</span> <span class="n">gcat&#39;</span><span class="p">)</span> <span class="o">$</span>
          <span class="n">groupByGeneralCategory</span> <span class="p">(</span><span class="n">minBound</span><span class="p">,</span> <span class="n">maxBound</span><span class="p">)</span>

<span class="nf">runRegexpToNFA</span> <span class="ow">::</span> <span class="kt">RegexpToNFA</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
<span class="nf">runRegexpToNFA</span> <span class="ow">=</span> <span class="n">flip</span> <span class="kt">State</span><span class="o">.</span><span class="n">evalState</span> <span class="o">$</span> <span class="kt">RegexpToNFAState</span> <span class="p">{</span> <span class="n">nfaFreshState</span> <span class="ow">=</span> <span class="mi">1</span> <span class="p">}</span>

<span class="nf">generateFreshNFAState</span> <span class="ow">::</span> <span class="kt">RegexpToNFA</span> <span class="kt">NFAState</span>
<span class="nf">generateFreshNFAState</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">nfaFreshState&#39;</span> <span class="ow">&lt;-</span> <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="n">nfaFreshState</span>
  <span class="kt">State</span><span class="o">.</span><span class="n">modify</span> <span class="o">$</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="n">s</span> <span class="p">{</span> <span class="n">nfaFreshState</span> <span class="ow">=</span> <span class="n">nfaFreshState</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="n">return</span> <span class="n">nfaFreshState&#39;</span>

<span class="nf">convertRegexpToNFA</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">RegexpToNFA</span> <span class="kt">NFA</span>
<span class="nf">convertRegexpToNFA</span> <span class="kt">Empty</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">nfaInitialState&#39;</span> <span class="ow">&lt;-</span> <span class="n">generateFreshNFAState</span>
  <span class="n">return</span> <span class="o">$</span> <span class="kt">NFA</span>
    <span class="p">{</span> <span class="n">nfaInitialState</span> <span class="ow">=</span> <span class="n">nfaInitialState&#39;</span>
    <span class="p">,</span> <span class="n">nfaFinalStates</span> <span class="ow">=</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">empty</span>
    <span class="p">,</span> <span class="n">nfaTransition</span> <span class="ow">=</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">empty</span> <span class="p">}</span>
<span class="nf">convertRegexpToNFA</span> <span class="kt">Epsilon</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">nfaInitialState&#39;</span> <span class="ow">&lt;-</span> <span class="n">generateFreshNFAState</span>
  <span class="kr">let</span> <span class="n">nfaFinalStates&#39;</span> <span class="ow">=</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">singleton</span> <span class="n">nfaInitialState&#39;</span>
  <span class="n">return</span> <span class="o">$</span> <span class="kt">NFA</span>
    <span class="p">{</span> <span class="n">nfaInitialState</span> <span class="ow">=</span> <span class="n">nfaInitialState&#39;</span>
    <span class="p">,</span> <span class="n">nfaFinalStates</span> <span class="ow">=</span> <span class="n">nfaFinalStates&#39;</span>
    <span class="p">,</span> <span class="n">nfaTransition</span> <span class="ow">=</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">empty</span> <span class="p">}</span>
<span class="nf">convertRegexpToNFA</span> <span class="p">(</span><span class="kt">Ranges</span> <span class="n">ranges</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">nfaInitialState&#39;</span> <span class="ow">&lt;-</span> <span class="n">generateFreshNFAState</span>
  <span class="n">nfaFinalStates&#39;</span> <span class="ow">&lt;-</span> <span class="n">fmap</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">singleton</span> <span class="n">generateFreshNFAState</span>
  <span class="n">return</span> <span class="o">$</span> <span class="kt">NFA</span>
    <span class="p">{</span> <span class="n">nfaInitialState</span> <span class="ow">=</span> <span class="n">nfaInitialState&#39;</span>
    <span class="p">,</span> <span class="n">nfaFinalStates</span> <span class="ow">=</span> <span class="n">nfaFinalStates&#39;</span>
    <span class="p">,</span> <span class="n">nfaTransition</span> <span class="ow">=</span>
        <span class="kt">RBMap</span><span class="o">.</span><span class="n">singleton</span> <span class="p">(</span><span class="n">nfaInitialState&#39;</span><span class="p">,</span> <span class="kt">NFARanges</span> <span class="n">ranges</span><span class="p">)</span> <span class="n">nfaFinalStates&#39;</span> <span class="p">}</span>
<span class="nf">convertRegexpToNFA</span> <span class="p">(</span><span class="n">regexp1</span> <span class="kt">:::</span> <span class="n">regexp2</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">nfa1</span> <span class="ow">&lt;-</span> <span class="n">convertRegexpToNFA</span> <span class="n">regexp1</span>
  <span class="n">nfa2</span> <span class="ow">&lt;-</span> <span class="n">convertRegexpToNFA</span> <span class="n">regexp2</span>
  <span class="n">return</span> <span class="o">$</span> <span class="kt">NFA</span>
    <span class="p">{</span> <span class="n">nfaInitialState</span> <span class="ow">=</span> <span class="n">nfaInitialState</span> <span class="n">nfa1</span>
    <span class="p">,</span> <span class="n">nfaFinalStates</span> <span class="ow">=</span> <span class="n">nfaFinalStates</span> <span class="n">nfa2</span>
    <span class="p">,</span> <span class="n">nfaTransition</span> <span class="ow">=</span>
        <span class="kt">RBMap</span><span class="o">.</span><span class="n">unionsBy</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">union</span>
          <span class="p">[</span> <span class="n">nfaTransition</span> <span class="n">nfa1</span>
          <span class="p">,</span> <span class="n">nfaTransition</span> <span class="n">nfa2</span>
          <span class="p">,</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">map</span>
              <span class="p">(</span><span class="nf">\</span><span class="n">nfaMiddleState</span> <span class="ow">-&gt;</span>
                <span class="p">(</span> <span class="p">(</span><span class="n">nfaMiddleState</span><span class="p">,</span> <span class="kt">NFAEpsilon</span><span class="p">)</span>
                <span class="p">,</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">singleton</span> <span class="o">$</span> <span class="n">nfaInitialState</span> <span class="n">nfa2</span> <span class="p">))</span>
              <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="p">(</span><span class="n">nfaFinalStates</span> <span class="n">nfa1</span><span class="p">))</span> <span class="p">]</span> <span class="p">}</span>
<span class="nf">convertRegexpToNFA</span> <span class="p">(</span><span class="n">regexp1</span> <span class="kt">:|:</span> <span class="n">regexp2</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">nfaInitialState&#39;</span> <span class="ow">&lt;-</span> <span class="n">generateFreshNFAState</span>
  <span class="n">nfa1</span> <span class="ow">&lt;-</span> <span class="n">convertRegexpToNFA</span> <span class="n">regexp1</span>
  <span class="n">nfa2</span> <span class="ow">&lt;-</span> <span class="n">convertRegexpToNFA</span> <span class="n">regexp2</span>
  <span class="n">return</span> <span class="o">$</span> <span class="kt">NFA</span>
    <span class="p">{</span> <span class="n">nfaInitialState</span> <span class="ow">=</span> <span class="n">nfaInitialState&#39;</span>
    <span class="p">,</span> <span class="n">nfaFinalStates</span> <span class="ow">=</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">union</span> <span class="p">(</span><span class="n">nfaFinalStates</span> <span class="n">nfa1</span><span class="p">)</span> <span class="p">(</span><span class="n">nfaFinalStates</span> <span class="n">nfa2</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">nfaTransition</span> <span class="ow">=</span>
        <span class="kt">RBMap</span><span class="o">.</span><span class="n">unionsBy</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">union</span>
          <span class="p">[</span> <span class="n">nfaTransition</span> <span class="n">nfa1</span>
          <span class="p">,</span> <span class="n">nfaTransition</span> <span class="n">nfa2</span>
          <span class="p">,</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">singleton</span>
              <span class="p">(</span><span class="n">nfaInitialState&#39;</span><span class="p">,</span> <span class="kt">NFAEpsilon</span><span class="p">)</span>
              <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="p">[</span><span class="n">nfaInitialState</span> <span class="n">nfa1</span><span class="p">,</span> <span class="n">nfaInitialState</span> <span class="n">nfa2</span><span class="p">])</span> <span class="p">]</span> <span class="p">}</span>
<span class="nf">convertRegexpToNFA</span> <span class="p">(</span><span class="kt">Many</span> <span class="n">regexp</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">nfa</span> <span class="ow">&lt;-</span> <span class="n">convertRegexpToNFA</span> <span class="n">regexp</span>
  <span class="n">return</span> <span class="o">$</span> <span class="kt">NFA</span>
    <span class="p">{</span> <span class="n">nfaInitialState</span> <span class="ow">=</span> <span class="n">nfaInitialState</span> <span class="n">nfa</span>
    <span class="p">,</span> <span class="n">nfaFinalStates</span> <span class="ow">=</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">singleton</span> <span class="o">$</span> <span class="n">nfaInitialState</span> <span class="n">nfa</span> <span class="c1">-- $ nfaFinalStates nfa</span>
    <span class="p">,</span> <span class="n">nfaTransition</span> <span class="ow">=</span>
        <span class="kt">RBMap</span><span class="o">.</span><span class="n">unionBy</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">union</span> <span class="p">(</span><span class="n">nfaTransition</span> <span class="n">nfa</span><span class="p">)</span> <span class="o">$</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">map</span>
          <span class="p">(</span><span class="nf">\</span><span class="n">nfaLoopState</span> <span class="ow">-&gt;</span>
            <span class="p">(</span> <span class="p">(</span><span class="n">nfaLoopState</span><span class="p">,</span> <span class="kt">NFAEpsilon</span><span class="p">)</span>
            <span class="p">,</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">singleton</span> <span class="o">$</span> <span class="n">nfaInitialState</span> <span class="n">nfa</span> <span class="p">))</span>
          <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="p">(</span><span class="n">nfaFinalStates</span> <span class="n">nfa</span><span class="p">))</span> <span class="p">}</span>

<span class="nf">runNFAToDFA</span> <span class="ow">::</span> <span class="kt">NFAToDFA</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
<span class="nf">runNFAToDFA</span> <span class="ow">=</span>
  <span class="n">flip</span> <span class="kt">State</span><span class="o">.</span><span class="n">evalState</span> <span class="o">$</span> <span class="kt">NFAToDFAState</span>
    <span class="p">{</span> <span class="n">dfaStates</span> <span class="ow">=</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">empty</span>
    <span class="p">,</span> <span class="n">dfaFreshState</span> <span class="ow">=</span> <span class="mi">1</span>
    <span class="p">,</span> <span class="n">dfaCurrentState</span> <span class="ow">=</span> <span class="mi">0</span>
    <span class="p">,</span> <span class="n">dfaTrans</span> <span class="ow">=</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">empty</span> <span class="p">}</span>

<span class="nf">convertNFAToDFA</span> <span class="ow">::</span> <span class="kt">NFA</span> <span class="ow">-&gt;</span> <span class="kt">NFAToDFA</span> <span class="kt">DFA</span>
<span class="nf">convertNFAToDFA</span> <span class="n">nfa</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">isEmpty</span> <span class="ow">&lt;-</span> <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="p">(</span><span class="kt">RBMap</span><span class="o">.</span><span class="n">null</span> <span class="o">.</span> <span class="n">dfaStates</span><span class="p">)</span>
  <span class="kt">Monad</span><span class="o">.</span><span class="n">when</span> <span class="n">isEmpty</span> <span class="o">$</span>
    <span class="kt">State</span><span class="o">.</span><span class="n">modify</span> <span class="o">$</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span>
      <span class="n">s</span> <span class="p">{</span> <span class="n">dfaStates</span> <span class="ow">=</span>
            <span class="kt">RBMap</span><span class="o">.</span><span class="n">fromList</span>
              <span class="p">[</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span>
              <span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">closure</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">singleton</span> <span class="p">(</span><span class="n">nfaInitialState</span> <span class="n">nfa</span><span class="p">)))</span> <span class="p">]</span> <span class="p">}</span>
  <span class="n">makeDFA</span>
  <span class="n">states</span> <span class="ow">&lt;-</span> <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="n">dfaStates</span>
  <span class="n">dfaTransition&#39;</span> <span class="ow">&lt;-</span> <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="n">dfaTrans</span>
  <span class="kr">let</span> <span class="n">dfaFinalStates&#39;&#39;</span> <span class="ow">=</span>
        <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">keys</span> <span class="o">$</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">filter</span>
          <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">any</span> <span class="p">(</span><span class="n">flip</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">member</span> <span class="p">(</span><span class="n">nfaFinalStates</span> <span class="n">nfa</span><span class="p">)))</span>
          <span class="n">states</span>
  <span class="n">return</span> <span class="o">$</span> <span class="kt">DFA</span>
    <span class="p">{</span> <span class="n">dfaInitialState</span> <span class="ow">=</span> <span class="mi">1</span>
    <span class="p">,</span> <span class="n">dfaFinalStates</span> <span class="ow">=</span> <span class="n">dfaFinalStates&#39;&#39;</span>
    <span class="p">,</span> <span class="n">dfaTransition</span> <span class="ow">=</span> <span class="n">dfaTransition&#39;</span> <span class="p">}</span>
  <span class="kr">where</span>
    <span class="n">closure</span> <span class="n">states</span> <span class="ow">=</span>
      <span class="kr">let</span> <span class="n">nfaTransition&#39;</span> <span class="ow">=</span>
            <span class="n">flip</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">filteri</span> <span class="p">(</span><span class="n">nfaTransition</span> <span class="n">nfa</span><span class="p">)</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="kr">_</span> <span class="ow">-&gt;</span>
              <span class="kt">RBSet</span><span class="o">.</span><span class="n">member</span> <span class="n">s</span> <span class="n">states</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">==</span> <span class="kt">NFAEpsilon</span> <span class="kr">in</span>
      <span class="kr">let</span> <span class="n">states&#39;</span> <span class="ow">=</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">unions</span> <span class="o">$</span> <span class="n">states</span> <span class="kt">:</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">elts</span> <span class="n">nfaTransition&#39;</span> <span class="kr">in</span>
        <span class="kr">if</span> <span class="n">states</span> <span class="o">==</span> <span class="n">states&#39;</span> <span class="kr">then</span>
          <span class="n">states</span>
        <span class="kr">else</span>
          <span class="n">closure</span> <span class="n">states&#39;</span>

    <span class="n">dfaLabel</span> <span class="kt">NFAEpsilon</span> <span class="ow">=</span>
      <span class="kt">Nothing</span>
    <span class="n">dfaLabel</span> <span class="p">(</span><span class="kt">NFARanges</span> <span class="n">ranges</span><span class="p">)</span> <span class="ow">=</span>
      <span class="kt">Just</span> <span class="o">$</span> <span class="kt">DFARanges</span> <span class="n">ranges</span>

    <span class="n">splitRange</span> <span class="n">range1</span> <span class="n">range2</span> <span class="ow">=</span>
      <span class="kr">let</span> <span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span> <span class="ow">=</span> <span class="n">range1</span> <span class="kr">in</span>
      <span class="kr">let</span> <span class="p">(</span><span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">)</span> <span class="ow">=</span> <span class="n">range2</span> <span class="kr">in</span>
        <span class="kr">if</span> <span class="n">range1</span> <span class="o">==</span> <span class="n">range2</span> <span class="kr">then</span>
          <span class="kt">[]</span>
        <span class="kr">else</span> <span class="kr">if</span> <span class="n">c1</span> <span class="o">&gt;</span> <span class="n">c4</span> <span class="o">||</span> <span class="n">c2</span> <span class="o">&lt;</span> <span class="n">c3</span> <span class="kr">then</span>
          <span class="p">[</span><span class="n">range2</span><span class="p">]</span>
        <span class="kr">else</span> <span class="kr">if</span> <span class="n">subsetRange</span> <span class="n">range1</span> <span class="n">range2</span> <span class="kr">then</span>
          <span class="kr">if</span> <span class="n">c1</span> <span class="o">==</span> <span class="n">minBound</span> <span class="o">&amp;&amp;</span> <span class="n">c2</span> <span class="o">==</span> <span class="n">maxBound</span> <span class="kr">then</span>
            <span class="kt">[]</span>
          <span class="kr">else</span> <span class="kr">if</span> <span class="n">c1</span> <span class="o">==</span> <span class="n">minBound</span> <span class="kr">then</span>
            <span class="p">[(</span><span class="n">succ</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c4</span><span class="p">)]</span>
          <span class="kr">else</span> <span class="kr">if</span> <span class="n">c2</span> <span class="o">==</span> <span class="n">maxBound</span> <span class="kr">then</span>
            <span class="p">[(</span><span class="n">c3</span><span class="p">,</span> <span class="n">pred</span> <span class="n">c1</span><span class="p">)]</span>
          <span class="kr">else</span>
            <span class="p">[(</span><span class="n">c3</span><span class="p">,</span> <span class="n">pred</span> <span class="n">c1</span><span class="p">),</span> <span class="p">(</span><span class="n">succ</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c4</span><span class="p">)]</span>
        <span class="kr">else</span> <span class="kr">if</span> <span class="n">subsetRange</span> <span class="n">range2</span> <span class="n">range1</span> <span class="kr">then</span>
          <span class="kt">[]</span>
        <span class="kr">else</span>
          <span class="kr">if</span> <span class="n">c1</span> <span class="o">&gt;</span> <span class="n">c3</span> <span class="kr">then</span>
            <span class="p">[(</span><span class="n">c3</span><span class="p">,</span> <span class="n">pred</span> <span class="n">c1</span><span class="p">)]</span>
          <span class="kr">else</span> <span class="kr">if</span> <span class="n">c2</span> <span class="o">&lt;</span> <span class="n">c4</span> <span class="kr">then</span>
            <span class="p">[(</span><span class="n">succ</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c4</span><span class="p">)]</span>
          <span class="kr">else</span>
            <span class="kt">[]</span>

    <span class="n">splitRanges</span> <span class="ow">=</span> <span class="n">concatMap</span> <span class="o">.</span> <span class="n">splitRange</span>

    <span class="n">splitRanges&#39;</span> <span class="n">ranges</span> <span class="ow">=</span>
      <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">foldr</span> <span class="n">splitRanges</span> <span class="n">r</span> <span class="o">$</span> <span class="n">concat</span> <span class="o">$</span> <span class="n">filter</span> <span class="p">(</span><span class="nf">\</span><span class="n">r&#39;&#39;</span> <span class="ow">-&gt;</span> <span class="kt">Prelude</span><span class="o">.</span><span class="n">not</span> <span class="p">(</span><span class="n">all</span> <span class="p">(</span><span class="nf">\</span><span class="n">r&#39;</span> <span class="ow">-&gt;</span> <span class="kt">Prelude</span><span class="o">.</span><span class="n">any</span> <span class="p">(</span><span class="n">subsetRange</span> <span class="n">r&#39;</span><span class="p">)</span> <span class="n">r&#39;&#39;</span><span class="p">)</span> <span class="n">r</span><span class="p">))</span> <span class="n">ranges</span><span class="p">)</span> <span class="n">ranges</span>

    <span class="n">dfaRanges</span> <span class="ow">=</span>
      <span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="o">$</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">map</span> <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="kt">Prelude</span><span class="o">.</span><span class="n">not</span> <span class="o">.</span> <span class="n">nullRange</span><span class="p">))</span> <span class="o">$</span> <span class="n">splitRanges&#39;</span> <span class="o">$</span> <span class="p">[(</span><span class="n">minBound</span><span class="p">,</span> <span class="n">maxBound</span><span class="p">)]</span> <span class="kt">:</span> <span class="p">(</span><span class="kt">Maybe</span><span class="o">.</span><span class="n">mapMaybe</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">-&gt;</span>
        <span class="kr">case</span> <span class="n">c</span> <span class="kr">of</span>
          <span class="kt">NFAEpsilon</span> <span class="ow">-&gt;</span> <span class="kt">Nothing</span>
          <span class="kt">NFARanges</span> <span class="n">ranges</span> <span class="ow">-&gt;</span> <span class="kt">Just</span> <span class="n">ranges</span>
          <span class="p">)</span> <span class="o">$</span>
        <span class="kt">RBMap</span><span class="o">.</span><span class="n">keys</span> <span class="o">$</span> <span class="n">nfaTransition</span> <span class="n">nfa</span><span class="p">)</span>

    <span class="n">dfaLabels</span> <span class="ow">=</span>
      <span class="n">map</span> <span class="kt">DFARanges</span> <span class="n">dfaRanges</span>

    <span class="n">subset</span> <span class="p">(</span><span class="kt">DFARanges</span> <span class="n">ranges1</span><span class="p">)</span> <span class="p">(</span><span class="kt">DFARanges</span> <span class="n">ranges2</span><span class="p">)</span> <span class="ow">=</span>
      <span class="n">all</span> <span class="p">(</span><span class="nf">\</span><span class="n">r</span> <span class="ow">-&gt;</span> <span class="kt">Prelude</span><span class="o">.</span><span class="n">any</span> <span class="p">(</span><span class="n">subsetRange</span> <span class="n">r</span><span class="p">)</span> <span class="n">ranges2</span><span class="p">)</span> <span class="n">ranges1</span>

    <span class="n">makeDFA</span> <span class="ow">=</span> <span class="kr">do</span>
      <span class="n">continue</span> <span class="ow">&lt;-</span> <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kt">NFAToDFAState</span> <span class="kr">_</span> <span class="n">p</span> <span class="n">j</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">)</span>
      <span class="kr">if</span> <span class="kt">Prelude</span><span class="o">.</span><span class="n">not</span> <span class="n">continue</span> <span class="kr">then</span>
        <span class="n">return</span> <span class="nb">()</span>
      <span class="kr">else</span> <span class="kr">do</span>
        <span class="kt">Monad</span><span class="o">.</span><span class="n">forM_</span> <span class="n">dfaLabels</span> <span class="o">$</span> <span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
          <span class="n">e</span> <span class="ow">&lt;-</span>
            <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kt">NFAToDFAState</span> <span class="n">states</span> <span class="kr">_</span> <span class="n">j</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span>
              <span class="kr">case</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">lookup</span> <span class="n">j</span> <span class="n">states</span> <span class="kr">of</span>
                <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
                  <span class="n">undefined</span>
                <span class="kt">Just</span> <span class="n">states&#39;</span> <span class="ow">-&gt;</span>
                  <span class="n">closure</span> <span class="o">$</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">unions</span> <span class="o">$</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">elts</span> <span class="o">$</span>
                    <span class="n">flip</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">filteri</span> <span class="p">(</span><span class="n">nfaTransition</span> <span class="n">nfa</span><span class="p">)</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c&#39;</span><span class="p">)</span> <span class="kr">_</span> <span class="ow">-&gt;</span>
                      <span class="kr">case</span> <span class="n">dfaLabel</span> <span class="n">c&#39;</span> <span class="kr">of</span>
                        <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
                          <span class="kt">False</span>
                        <span class="kt">Just</span> <span class="n">c&#39;&#39;</span> <span class="ow">-&gt;</span>
                          <span class="kt">RBSet</span><span class="o">.</span><span class="n">member</span> <span class="n">s</span> <span class="n">states&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">subset</span> <span class="n">c</span> <span class="n">c&#39;&#39;</span>
          <span class="n">maybeI</span> <span class="ow">&lt;-</span>
            <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kt">NFAToDFAState</span> <span class="n">states</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span>
              <span class="n">fmap</span> <span class="n">fst</span> <span class="o">$</span> <span class="kt">List</span><span class="o">.</span><span class="n">find</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="n">states&#39;</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">states&#39;</span> <span class="o">==</span> <span class="n">e</span><span class="p">)</span> <span class="o">$</span>
                <span class="kt">RBMap</span><span class="o">.</span><span class="n">toList</span> <span class="n">states</span>
          <span class="kr">case</span> <span class="n">maybeI</span> <span class="kr">of</span>
            <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
              <span class="kt">State</span><span class="o">.</span><span class="n">modify</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kt">NFAToDFAState</span> <span class="n">states</span> <span class="n">p</span> <span class="n">j</span> <span class="n">trans</span><span class="p">)</span> <span class="ow">-&gt;</span>
                <span class="kr">let</span> <span class="n">p&#39;</span> <span class="ow">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span> <span class="kr">in</span>
                <span class="kr">let</span> <span class="n">states&#39;</span> <span class="ow">=</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">insert</span> <span class="n">p&#39;</span> <span class="n">e</span> <span class="n">states</span> <span class="kr">in</span>
                <span class="kr">let</span> <span class="n">trans&#39;</span> <span class="ow">=</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="n">p&#39;</span> <span class="n">trans</span> <span class="kr">in</span>
                  <span class="p">(</span><span class="kt">NFAToDFAState</span> <span class="n">states&#39;</span> <span class="n">p&#39;</span> <span class="n">j</span> <span class="n">trans&#39;</span><span class="p">)</span>
            <span class="kt">Just</span> <span class="n">i</span> <span class="ow">-&gt;</span>
              <span class="kt">State</span><span class="o">.</span><span class="n">modify</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kt">NFAToDFAState</span> <span class="n">states</span> <span class="n">p</span> <span class="n">j</span> <span class="n">trans</span><span class="p">)</span> <span class="ow">-&gt;</span>
                <span class="kr">let</span> <span class="n">trans&#39;</span> <span class="ow">=</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="n">i</span> <span class="n">trans</span> <span class="kr">in</span>
                  <span class="p">(</span><span class="kt">NFAToDFAState</span> <span class="n">states</span> <span class="n">p</span> <span class="n">j</span> <span class="n">trans&#39;</span><span class="p">)</span>
        <span class="kt">State</span><span class="o">.</span><span class="n">modify</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kt">NFAToDFAState</span> <span class="n">states</span> <span class="n">p</span> <span class="n">j</span> <span class="n">trans</span><span class="p">)</span> <span class="ow">-&gt;</span>
          <span class="kr">let</span> <span class="n">j&#39;</span> <span class="ow">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="kr">in</span>
            <span class="p">(</span><span class="kt">NFAToDFAState</span> <span class="n">states</span> <span class="n">p</span> <span class="n">j&#39;</span> <span class="n">trans</span><span class="p">)</span>
        <span class="n">makeDFA</span>

<span class="nf">convertRegexpToDFA</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">DFA</span>
<span class="nf">convertRegexpToDFA</span> <span class="ow">=</span> <span class="n">runNFAToDFA</span> <span class="o">.</span> <span class="n">convertNFAToDFA</span> <span class="o">.</span> <span class="n">runRegexpToNFA</span> <span class="o">.</span> <span class="n">convertRegexpToNFA</span>

<span class="nf">fillTable</span> <span class="ow">::</span> <span class="kt">DFA</span> <span class="ow">-&gt;</span> <span class="kt">RBSet</span><span class="o">.</span><span class="kt">RBSet</span> <span class="p">(</span><span class="kt">DFAState</span><span class="p">,</span> <span class="kt">DFAState</span><span class="p">)</span>
<span class="nf">fillTable</span> <span class="n">dfa</span> <span class="ow">=</span> <span class="n">fillTable&#39;</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">empty</span> <span class="n">initialTable</span> <span class="kr">where</span>
  <span class="n">states</span> <span class="ow">=</span>
    <span class="kt">RBSet</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">dfaInitialState</span> <span class="n">dfa</span><span class="p">)</span> <span class="o">$</span>
      <span class="kt">RBSet</span><span class="o">.</span><span class="n">union</span> <span class="p">(</span><span class="n">dfaFinalStates</span> <span class="n">dfa</span><span class="p">)</span> <span class="o">$</span>
      <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">concatMap</span> <span class="p">(</span><span class="nf">\</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="kr">_</span><span class="p">),</span> <span class="n">s&#39;</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">s&#39;</span><span class="p">])</span> <span class="o">$</span>
        <span class="kt">RBMap</span><span class="o">.</span><span class="n">toList</span> <span class="o">$</span> <span class="n">dfaTransition</span> <span class="n">dfa</span>

  <span class="n">initialTable</span> <span class="ow">=</span>
    <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span>
      <span class="p">(</span><span class="n">concatMap</span>
        <span class="p">(</span><span class="nf">\</span><span class="n">p</span> <span class="ow">-&gt;</span>
          <span class="n">concatMap</span> <span class="p">(</span><span class="nf">\</span><span class="n">q</span> <span class="ow">-&gt;</span> <span class="p">[(</span><span class="n">min</span> <span class="n">p</span> <span class="n">q</span><span class="p">,</span> <span class="n">max</span> <span class="n">p</span> <span class="n">q</span><span class="p">)])</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="p">(</span><span class="n">dfaFinalStates</span> <span class="n">dfa</span><span class="p">)))</span>
        <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">diff</span> <span class="n">states</span> <span class="p">(</span><span class="n">dfaFinalStates</span> <span class="n">dfa</span><span class="p">))))</span>

  <span class="n">m</span> <span class="ow">=</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span>
    <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="n">l</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">fst</span> <span class="p">(</span><span class="n">head</span> <span class="n">l</span><span class="p">),</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="o">$</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">map</span> <span class="n">snd</span> <span class="n">l</span><span class="p">))</span> <span class="o">$</span>
    <span class="kt">List</span><span class="o">.</span><span class="n">groupBy</span> <span class="p">(</span><span class="nf">\</span><span class="n">lhs</span> <span class="n">rhs</span> <span class="ow">-&gt;</span> <span class="n">fst</span> <span class="n">lhs</span> <span class="o">==</span> <span class="n">fst</span> <span class="n">rhs</span><span class="p">)</span> <span class="o">$</span>
    <span class="kt">List</span><span class="o">.</span><span class="n">sortBy</span> <span class="p">(</span><span class="nf">\</span><span class="n">lhs</span> <span class="n">rhs</span> <span class="ow">-&gt;</span> <span class="n">compare</span> <span class="p">(</span><span class="n">fst</span> <span class="n">lhs</span><span class="p">)</span> <span class="p">(</span><span class="n">fst</span> <span class="n">rhs</span><span class="p">))</span> <span class="o">$</span>
    <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">q</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">)))</span> <span class="o">$</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">toList</span> <span class="o">$</span> <span class="n">dfaTransition</span> <span class="n">dfa</span>

  <span class="n">fillTable&#39;</span> <span class="n">table</span> <span class="n">table&#39;</span> <span class="ow">=</span>
    <span class="kr">let</span> <span class="n">table&#39;&#39;</span> <span class="ow">=</span>
          <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span>
            <span class="n">concatMap</span>
              <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="ow">-&gt;</span>
                <span class="kr">case</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">lookup</span> <span class="n">p</span> <span class="n">m</span> <span class="kr">of</span>
                  <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
                    <span class="kt">[]</span>
                  <span class="kt">Just</span> <span class="n">l</span> <span class="ow">-&gt;</span>
                    <span class="kr">case</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">lookup</span> <span class="n">q</span> <span class="n">m</span> <span class="kr">of</span>
                      <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
                        <span class="kt">[]</span>
                      <span class="kt">Just</span> <span class="n">l&#39;</span> <span class="ow">-&gt;</span>
                        <span class="n">concatMap</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">p&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span><span class="o">.</span><span class="n">mapMaybe</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">q&#39;</span><span class="p">,</span> <span class="n">c&#39;</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kr">if</span> <span class="n">p&#39;</span> <span class="o">/=</span> <span class="n">q&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">==</span> <span class="n">c&#39;</span> <span class="kr">then</span> <span class="kt">Just</span> <span class="p">(</span><span class="n">min</span> <span class="n">p&#39;</span> <span class="n">q&#39;</span><span class="p">,</span> <span class="n">max</span> <span class="n">p&#39;</span> <span class="n">q&#39;</span><span class="p">)</span> <span class="kr">else</span> <span class="kt">Nothing</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span> <span class="n">l&#39;</span><span class="p">)</span>
              <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="n">table&#39;</span><span class="p">)</span> <span class="kr">in</span>
      <span class="kr">if</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">union</span> <span class="n">table</span> <span class="n">table&#39;</span> <span class="o">==</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">unions</span> <span class="p">[</span><span class="n">table</span><span class="p">,</span> <span class="n">table&#39;</span><span class="p">,</span> <span class="n">table&#39;&#39;</span><span class="p">]</span> <span class="kr">then</span>
        <span class="kt">RBSet</span><span class="o">.</span><span class="n">union</span> <span class="n">table</span> <span class="n">table&#39;</span>
      <span class="kr">else</span>
        <span class="n">fillTable&#39;</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">union</span> <span class="n">table</span> <span class="n">table&#39;</span><span class="p">)</span> <span class="n">table&#39;&#39;</span>

<span class="nf">minimize</span> <span class="ow">::</span> <span class="kt">DFA</span> <span class="ow">-&gt;</span> <span class="kt">DFA</span>
<span class="nf">minimize</span> <span class="n">dfa</span> <span class="ow">=</span> <span class="kt">DFA</span>
  <span class="p">{</span> <span class="n">dfaTransition</span> <span class="ow">=</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">q</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">((</span><span class="n">mapState</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">mapState</span> <span class="n">q</span><span class="p">))</span> <span class="o">$</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">toList</span> <span class="o">$</span> <span class="n">dfaTransition</span> <span class="n">dfa</span>
  <span class="p">,</span> <span class="n">dfaInitialState</span> <span class="ow">=</span> <span class="n">mapState</span> <span class="o">$</span> <span class="n">dfaInitialState</span> <span class="n">dfa</span>
  <span class="p">,</span> <span class="n">dfaFinalStates</span> <span class="ow">=</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">map</span> <span class="n">mapState</span> <span class="o">$</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="o">$</span> <span class="n">dfaFinalStates</span> <span class="n">dfa</span> <span class="p">}</span> <span class="kr">where</span>
    <span class="n">states</span> <span class="ow">=</span>
      <span class="kt">RBSet</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">dfaInitialState</span> <span class="n">dfa</span><span class="p">)</span> <span class="o">$</span>
        <span class="kt">RBSet</span><span class="o">.</span><span class="n">union</span> <span class="p">(</span><span class="n">dfaFinalStates</span> <span class="n">dfa</span><span class="p">)</span> <span class="o">$</span>
        <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">concatMap</span> <span class="p">(</span><span class="nf">\</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="kr">_</span><span class="p">),</span> <span class="n">s&#39;</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">s&#39;</span><span class="p">])</span> <span class="o">$</span>
          <span class="kt">RBMap</span><span class="o">.</span><span class="n">toList</span> <span class="o">$</span> <span class="n">dfaTransition</span> <span class="n">dfa</span>

    <span class="n">table</span> <span class="ow">=</span> <span class="n">fillTable</span> <span class="n">dfa</span>

    <span class="n">p</span> <span class="o">/==</span> <span class="n">q</span> <span class="ow">=</span>
      <span class="kt">RBSet</span><span class="o">.</span><span class="n">member</span> <span class="p">(</span><span class="n">min</span> <span class="n">p</span> <span class="n">q</span><span class="p">,</span> <span class="n">max</span> <span class="n">p</span> <span class="n">q</span><span class="p">)</span> <span class="n">table</span>

    <span class="n">p</span> <span class="o">===</span> <span class="n">q</span> <span class="ow">=</span>
      <span class="kt">Prelude</span><span class="o">.</span><span class="n">not</span> <span class="o">$</span> <span class="n">p</span> <span class="o">/==</span> <span class="n">q</span>

    <span class="n">eqStates</span> <span class="ow">=</span>
      <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">map</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">foldr</span>
        <span class="p">(</span><span class="nf">\</span><span class="n">q</span> <span class="n">s</span> <span class="ow">-&gt;</span>
          <span class="kr">let</span> <span class="n">s&#39;</span> <span class="ow">=</span>
                <span class="n">map</span>
                  <span class="p">(</span><span class="nf">\</span><span class="n">qs</span> <span class="ow">-&gt;</span>
                    <span class="kr">if</span> <span class="kt">Maybe</span><span class="o">.</span><span class="n">isJust</span> <span class="p">(</span><span class="kt">List</span><span class="o">.</span><span class="n">find</span> <span class="p">(</span><span class="nf">\</span><span class="n">q&#39;</span> <span class="ow">-&gt;</span> <span class="n">q</span> <span class="o">===</span> <span class="n">q&#39;</span><span class="p">)</span> <span class="n">qs</span><span class="p">)</span> <span class="kr">then</span>
                      <span class="n">q</span> <span class="kt">:</span> <span class="n">qs</span>
                    <span class="kr">else</span>
                      <span class="n">qs</span><span class="p">)</span>
                  <span class="n">s</span> <span class="kr">in</span>
            <span class="kr">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">s&#39;</span> <span class="kr">then</span>
              <span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="kt">:</span> <span class="n">s</span>
            <span class="kr">else</span>
              <span class="n">s&#39;</span><span class="p">)</span>
        <span class="kt">[]</span>
        <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="n">states</span><span class="p">)</span>

    <span class="n">mapState</span> <span class="n">q</span> <span class="ow">=</span>
      <span class="kr">case</span> <span class="kt">List</span><span class="o">.</span><span class="n">find</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">member</span> <span class="n">q</span> <span class="n">qs</span><span class="p">)</span> <span class="o">$</span> <span class="n">zip</span> <span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="p">]</span> <span class="o">$</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="n">eqStates</span> <span class="kr">of</span>
        <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
          <span class="n">undefined</span>
        <span class="kt">Just</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span>
          <span class="n">i</span>

<span class="nf">runDFAToRegexp</span> <span class="ow">::</span> <span class="kt">DFAToRegexp</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
<span class="nf">runDFAToRegexp</span> <span class="ow">=</span> <span class="n">flip</span> <span class="kt">State</span><span class="o">.</span><span class="n">evalState</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span>

<span class="nf">convertDFAToRegexp</span> <span class="ow">::</span> <span class="kt">DFA</span> <span class="ow">-&gt;</span> <span class="kt">DFAToRegexp</span> <span class="kt">Regexp</span>
<span class="nf">convertDFAToRegexp</span> <span class="n">dfa</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="kt">State</span><span class="o">.</span><span class="n">put</span> <span class="p">(</span><span class="n">initialState</span><span class="p">,</span> <span class="n">finalState</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">insert</span> <span class="n">initialState</span> <span class="o">$</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">insert</span> <span class="n">finalState</span> <span class="o">$</span> <span class="n">states</span><span class="p">)</span>
  <span class="kt">Monad</span><span class="o">.</span><span class="n">forM_</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="n">states</span><span class="p">)</span> <span class="o">$</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
    <span class="kt">State</span><span class="o">.</span><span class="n">modify</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">states&#39;</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">delete</span> <span class="n">s</span> <span class="n">states&#39;</span><span class="p">)</span>
    <span class="n">states&#39;</span> <span class="ow">&lt;-</span> <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">states&#39;</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">states&#39;</span>
    <span class="kt">Monad</span><span class="o">.</span><span class="n">forM_</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="n">states&#39;</span><span class="p">)</span> <span class="o">$</span> <span class="nf">\</span><span class="n">q</span> <span class="ow">-&gt;</span>
      <span class="kt">Monad</span><span class="o">.</span><span class="n">forM_</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">delete</span> <span class="n">q</span> <span class="n">states&#39;</span><span class="p">))</span> <span class="o">$</span> <span class="nf">\</span><span class="n">q&#39;</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
        <span class="n">regexp1</span> <span class="ow">&lt;-</span>
          <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span>
            <span class="kr">case</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">lookup</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="n">m</span> <span class="kr">of</span>
              <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="kt">Empty</span>
              <span class="kt">Just</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">r</span>
        <span class="n">regexp2</span> <span class="ow">&lt;-</span>
          <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span>
            <span class="kr">case</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">lookup</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="n">m</span> <span class="kr">of</span>
              <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="kt">Empty</span>
              <span class="kt">Just</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">r</span>
        <span class="n">regexp3</span> <span class="ow">&lt;-</span>
          <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span>
            <span class="kr">case</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">lookup</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">q&#39;</span><span class="p">)</span> <span class="n">m</span> <span class="kr">of</span>
              <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="kt">Empty</span>
              <span class="kt">Just</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">r</span>
        <span class="n">regexp4</span> <span class="ow">&lt;-</span>
          <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span>
            <span class="kr">case</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">lookup</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q&#39;</span><span class="p">)</span> <span class="n">m</span> <span class="kr">of</span>
              <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="kt">Empty</span>
              <span class="kt">Just</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">r</span>
        <span class="kt">State</span><span class="o">.</span><span class="n">modify</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">states&#39;&#39;</span><span class="p">)</span> <span class="ow">-&gt;</span>
          <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q&#39;</span><span class="p">)</span> <span class="p">(</span><span class="n">minimizeRegexp</span> <span class="p">(</span><span class="n">regexp1</span> <span class="kt">:::</span> <span class="kt">Many</span> <span class="n">regexp2</span> <span class="kt">:::</span> <span class="n">regexp3</span> <span class="kt">:|:</span> <span class="n">regexp4</span><span class="p">))</span> <span class="n">m</span><span class="p">,</span> <span class="n">states&#39;&#39;</span><span class="p">)</span>
  <span class="kt">State</span><span class="o">.</span><span class="n">gets</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="kr">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span>
    <span class="kr">case</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">lookup</span> <span class="p">(</span><span class="n">initialState</span><span class="p">,</span> <span class="n">finalState</span><span class="p">)</span> <span class="n">m</span> <span class="kr">of</span>
      <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="kt">Empty</span>
      <span class="kt">Just</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">r</span>
  <span class="kr">where</span>
    <span class="n">states</span> <span class="ow">=</span>
      <span class="kt">RBSet</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">dfaInitialState</span> <span class="n">dfa</span><span class="p">)</span> <span class="o">$</span>
        <span class="kt">RBSet</span><span class="o">.</span><span class="n">union</span> <span class="p">(</span><span class="n">dfaFinalStates</span> <span class="n">dfa</span><span class="p">)</span> <span class="o">$</span>
        <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">concatMap</span> <span class="p">(</span><span class="nf">\</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="kr">_</span><span class="p">),</span> <span class="n">s&#39;</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">s&#39;</span><span class="p">])</span> <span class="o">$</span>
          <span class="kt">RBMap</span><span class="o">.</span><span class="n">toList</span> <span class="o">$</span> <span class="n">dfaTransition</span> <span class="n">dfa</span>

    <span class="n">initialState</span> <span class="ow">=</span> <span class="n">maybe</span> <span class="mi">0</span> <span class="n">id</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">maximum</span> <span class="n">states</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">finalState</span> <span class="ow">=</span> <span class="n">maybe</span> <span class="mi">0</span> <span class="n">id</span> <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">maximum</span> <span class="n">states</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>

    <span class="n">mapping</span> <span class="ow">=</span>
      <span class="kt">RBMap</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">initialState</span><span class="p">,</span> <span class="n">finalState</span><span class="p">)</span> <span class="kt">Empty</span> <span class="o">$</span>
        <span class="kt">RBMap</span><span class="o">.</span><span class="n">unionsBy</span> <span class="p">(</span><span class="kt">:|:</span><span class="p">)</span>
          <span class="p">[</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">fromList</span>
              <span class="p">(</span><span class="n">map</span>
                <span class="p">(</span><span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span>
                  <span class="kr">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">dfaInitialState</span> <span class="n">dfa</span> <span class="kr">then</span>
                    <span class="p">((</span><span class="n">initialState</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span> <span class="kt">Epsilon</span><span class="p">)</span>
                  <span class="kr">else</span>
                    <span class="p">((</span><span class="n">initialState</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span> <span class="kt">Empty</span><span class="p">))</span>
                <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="n">states</span><span class="p">))</span>
          <span class="p">,</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">fromList</span>
              <span class="p">(</span><span class="n">map</span>
                <span class="p">(</span><span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span>
                  <span class="kr">if</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">member</span> <span class="n">s</span> <span class="p">(</span><span class="n">dfaFinalStates</span> <span class="n">dfa</span><span class="p">)</span> <span class="kr">then</span>
                    <span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">finalState</span><span class="p">),</span> <span class="kt">Epsilon</span><span class="p">)</span>
                  <span class="kr">else</span>
                    <span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">finalState</span><span class="p">),</span> <span class="kt">Empty</span><span class="p">))</span>
                <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="n">states</span><span class="p">))</span>
          <span class="p">,</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">fromList</span>
              <span class="p">(</span><span class="n">concatMap</span>
                <span class="p">(</span><span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span>
                  <span class="n">map</span>
                    <span class="p">(</span><span class="nf">\</span><span class="n">s&#39;</span> <span class="ow">-&gt;</span>
                      <span class="kr">case</span> <span class="kt">List</span><span class="o">.</span><span class="n">filter</span> <span class="p">(</span><span class="nf">\</span><span class="p">((</span><span class="n">s1</span><span class="p">,</span> <span class="kr">_</span><span class="p">),</span> <span class="n">s2</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">s1</span> <span class="o">==</span> <span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="n">s2</span> <span class="o">==</span> <span class="n">s&#39;</span><span class="p">)</span> <span class="p">(</span><span class="kt">RBMap</span><span class="o">.</span><span class="n">toList</span> <span class="p">(</span><span class="n">dfaTransition</span> <span class="n">dfa</span><span class="p">))</span> <span class="kr">of</span>
                        <span class="kt">[]</span> <span class="ow">-&gt;</span>
                          <span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">s&#39;</span><span class="p">),</span> <span class="kt">Empty</span><span class="p">)</span>
                        <span class="n">trans</span> <span class="ow">-&gt;</span>
                          <span class="kr">let</span> <span class="n">c&#39;</span> <span class="ow">=</span>
                                <span class="n">foldr</span>
                                  <span class="p">(</span><span class="nf">\</span><span class="p">((</span><span class="kr">_</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="kr">_</span><span class="p">)</span> <span class="n">r</span> <span class="ow">-&gt;</span>
                                    <span class="kr">case</span> <span class="n">c</span> <span class="kr">of</span>
                                      <span class="kt">DFARanges</span> <span class="n">ranges</span> <span class="ow">-&gt;</span>
                                        <span class="kt">Ranges</span> <span class="n">ranges</span> <span class="kt">:|:</span> <span class="n">r</span><span class="p">)</span>
                                  <span class="kt">Empty</span>
                                  <span class="n">trans</span> <span class="kr">in</span>
                            <span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">s&#39;</span><span class="p">),</span> <span class="n">c&#39;</span><span class="p">))</span>
                    <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="n">states</span><span class="p">))</span>
                <span class="p">(</span><span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="n">states</span><span class="p">))</span> <span class="p">]</span>

    <span class="n">minimizeRegexp</span> <span class="ow">::</span> <span class="kt">Regexp</span> <span class="ow">-&gt;</span> <span class="kt">Regexp</span>
    <span class="n">minimizeRegexp</span> <span class="kt">Empty</span> <span class="ow">=</span> <span class="kt">Empty</span>
    <span class="n">minimizeRegexp</span> <span class="kt">Epsilon</span> <span class="ow">=</span> <span class="kt">Epsilon</span>
    <span class="n">minimizeRegexp</span> <span class="p">(</span><span class="kt">Ranges</span> <span class="n">ranges</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Ranges</span> <span class="n">ranges</span>
    <span class="n">minimizeRegexp</span> <span class="p">(</span><span class="n">r1</span> <span class="kt">:::</span> <span class="n">r2</span><span class="p">)</span> <span class="ow">=</span>
      <span class="kr">case</span> <span class="n">minimizeRegexp</span> <span class="n">r1</span> <span class="kr">of</span>
        <span class="kt">Empty</span> <span class="ow">-&gt;</span>
          <span class="kt">Empty</span>
        <span class="kt">Epsilon</span> <span class="ow">-&gt;</span>
          <span class="n">minimizeRegexp</span> <span class="n">r2</span>
        <span class="n">r1&#39;</span> <span class="ow">-&gt;</span>
          <span class="kr">case</span> <span class="n">minimizeRegexp</span> <span class="n">r2</span> <span class="kr">of</span>
            <span class="kt">Empty</span> <span class="ow">-&gt;</span>
              <span class="kt">Empty</span>
            <span class="kt">Epsilon</span> <span class="ow">-&gt;</span>
              <span class="n">r1&#39;</span>
            <span class="n">r2&#39;</span> <span class="ow">-&gt;</span>
              <span class="n">r1&#39;</span> <span class="kt">:::</span> <span class="n">r2&#39;</span>
    <span class="n">minimizeRegexp</span> <span class="p">(</span><span class="n">r1</span> <span class="kt">:|:</span> <span class="n">r2</span><span class="p">)</span> <span class="ow">=</span>
      <span class="kr">case</span> <span class="n">minimizeRegexp</span> <span class="n">r1</span> <span class="kr">of</span>
        <span class="kt">Empty</span> <span class="ow">-&gt;</span>
          <span class="n">minimizeRegexp</span> <span class="n">r2</span>
        <span class="n">r1&#39;</span> <span class="ow">-&gt;</span>
          <span class="kr">case</span> <span class="n">minimizeRegexp</span> <span class="n">r2</span> <span class="kr">of</span>
            <span class="kt">Empty</span> <span class="ow">-&gt;</span>
              <span class="n">r1&#39;</span>
            <span class="n">r2&#39;</span> <span class="ow">-&gt;</span>
              <span class="kr">case</span> <span class="p">(</span><span class="n">r1&#39;</span><span class="p">,</span> <span class="n">r2&#39;</span><span class="p">)</span> <span class="kr">of</span>
                <span class="p">(</span><span class="n">r3</span> <span class="kt">:::</span> <span class="kt">Many</span> <span class="n">r4</span><span class="p">,</span> <span class="kt">Epsilon</span><span class="p">)</span> <span class="ow">-&gt;</span>
                  <span class="kr">if</span> <span class="n">r3</span> <span class="o">==</span> <span class="n">r4</span> <span class="kr">then</span>
                    <span class="kt">Many</span> <span class="n">r4</span>
                  <span class="kr">else</span>
                    <span class="n">r1&#39;</span> <span class="kt">:|:</span> <span class="n">r2&#39;</span>
                <span class="p">(</span><span class="kt">Ranges</span> <span class="n">ranges1</span><span class="p">,</span> <span class="kt">Ranges</span> <span class="n">ranges2</span><span class="p">)</span> <span class="ow">-&gt;</span>
                  <span class="kt">Ranges</span> <span class="o">$</span> <span class="n">minimizeRanges</span> <span class="o">$</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">toList</span> <span class="o">$</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">ranges1</span> <span class="o">++</span> <span class="n">ranges2</span>
                <span class="kr">_</span> <span class="ow">-&gt;</span>
                  <span class="kr">if</span> <span class="n">r1&#39;</span> <span class="o">==</span> <span class="n">r2&#39;</span> <span class="kr">then</span>
                    <span class="n">r1&#39;</span>
                  <span class="kr">else</span>
                    <span class="n">r1&#39;</span> <span class="kt">:|:</span> <span class="n">r2&#39;</span>
    <span class="n">minimizeRegexp</span> <span class="p">(</span><span class="kt">Many</span> <span class="n">r</span><span class="p">)</span> <span class="ow">=</span>
      <span class="kr">case</span> <span class="n">minimizeRegexp</span> <span class="n">r</span> <span class="kr">of</span>
        <span class="kt">Empty</span> <span class="ow">-&gt;</span> <span class="kt">Epsilon</span>
        <span class="n">r&#39;</span> <span class="ow">-&gt;</span> <span class="kt">Many</span> <span class="n">r&#39;</span>

    <span class="n">minimizeRanges</span> <span class="kt">[]</span> <span class="ow">=</span> <span class="kt">[]</span>
    <span class="n">minimizeRanges</span> <span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="ow">=</span> <span class="p">[</span><span class="n">r</span><span class="p">]</span>
    <span class="n">minimizeRanges</span> <span class="p">(</span><span class="n">r1</span> <span class="kt">:</span> <span class="n">r2</span> <span class="kt">:</span> <span class="n">rs</span><span class="p">)</span> <span class="ow">=</span>
      <span class="kr">let</span> <span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span> <span class="ow">=</span> <span class="n">r1</span> <span class="kr">in</span>
      <span class="kr">let</span> <span class="p">(</span><span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">)</span> <span class="ow">=</span> <span class="n">r2</span> <span class="kr">in</span>
        <span class="kr">if</span> <span class="n">c2</span> <span class="o">==</span> <span class="n">maxBound</span> <span class="kr">then</span>
          <span class="p">[(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)]</span>
        <span class="kr">else</span> <span class="kr">if</span> <span class="n">succ</span> <span class="n">c2</span> <span class="o">==</span> <span class="n">c3</span> <span class="kr">then</span>
          <span class="n">minimizeRanges</span> <span class="p">((</span><span class="n">c1</span><span class="p">,</span> <span class="n">c4</span><span class="p">)</span> <span class="kt">:</span> <span class="n">rs</span><span class="p">)</span>
        <span class="kr">else</span>
          <span class="n">r1</span> <span class="kt">:</span> <span class="n">minimizeRanges</span> <span class="p">(</span><span class="n">r2</span> <span class="kt">:</span> <span class="n">rs</span><span class="p">)</span>

<span class="nf">complement</span> <span class="ow">::</span> <span class="kt">DFA</span> <span class="ow">-&gt;</span> <span class="kt">DFA</span>
<span class="nf">complement</span> <span class="n">dfa</span> <span class="ow">=</span> <span class="n">dfa</span> <span class="p">{</span> <span class="n">dfaFinalStates</span> <span class="ow">=</span> <span class="kt">RBSet</span><span class="o">.</span><span class="n">diff</span> <span class="n">states</span> <span class="o">$</span> <span class="n">dfaFinalStates</span> <span class="n">dfa</span> <span class="p">}</span>
  <span class="kr">where</span>
    <span class="n">states</span> <span class="ow">=</span>
      <span class="kt">RBSet</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">dfaInitialState</span> <span class="n">dfa</span><span class="p">)</span> <span class="o">$</span>
        <span class="kt">RBSet</span><span class="o">.</span><span class="n">union</span> <span class="p">(</span><span class="n">dfaFinalStates</span> <span class="n">dfa</span><span class="p">)</span> <span class="o">$</span>
        <span class="kt">RBSet</span><span class="o">.</span><span class="n">fromList</span> <span class="o">$</span> <span class="n">concatMap</span> <span class="p">(</span><span class="nf">\</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="kr">_</span><span class="p">),</span> <span class="n">s&#39;</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">s&#39;</span><span class="p">])</span> <span class="o">$</span>
          <span class="kt">RBMap</span><span class="o">.</span><span class="n">toList</span> <span class="o">$</span> <span class="n">dfaTransition</span> <span class="n">dfa</span>

<span class="p">(</span><span class="o">=~</span><span class="p">)</span> <span class="ow">::</span> <span class="kt">DFA</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
<span class="p">(</span><span class="o">=~</span><span class="p">)</span> <span class="n">dfa</span> <span class="ow">=</span> <span class="n">match</span> <span class="o">$</span> <span class="n">dfaInitialState</span> <span class="n">dfa</span>
  <span class="kr">where</span>
    <span class="n">sigma</span> <span class="ow">=</span> <span class="kt">List</span><span class="o">.</span><span class="n">nub</span> <span class="o">$</span> <span class="n">map</span> <span class="p">(</span><span class="n">snd</span> <span class="o">.</span> <span class="n">fst</span><span class="p">)</span> <span class="o">$</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">toList</span> <span class="o">$</span> <span class="n">dfaTransition</span> <span class="n">dfa</span>

    <span class="n">match</span> <span class="ow">::</span> <span class="kt">DFAState</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
    <span class="n">match</span> <span class="n">q</span> <span class="s">&quot;&quot;</span> <span class="ow">=</span>
      <span class="kt">RBSet</span><span class="o">.</span><span class="n">member</span> <span class="n">q</span> <span class="o">$</span> <span class="n">dfaFinalStates</span> <span class="n">dfa</span>
    <span class="n">match</span> <span class="n">q</span> <span class="p">(</span><span class="n">c</span> <span class="kt">:</span> <span class="n">s</span><span class="p">)</span> <span class="ow">=</span>
      <span class="kr">case</span> <span class="kt">List</span><span class="o">.</span><span class="n">find</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kt">DFARanges</span> <span class="n">ranges</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Prelude</span><span class="o">.</span><span class="n">any</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">c1</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="n">c2</span><span class="p">)</span> <span class="n">ranges</span><span class="p">)</span> <span class="n">sigma</span> <span class="kr">of</span>
        <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
          <span class="kt">False</span>
        <span class="kt">Just</span> <span class="n">lab</span> <span class="ow">-&gt;</span>
          <span class="kr">case</span> <span class="kt">RBMap</span><span class="o">.</span><span class="n">lookup</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span> <span class="o">$</span> <span class="n">dfaTransition</span> <span class="n">dfa</span> <span class="kr">of</span>
            <span class="kt">Nothing</span> <span class="ow">-&gt;</span>
              <span class="kt">False</span>
            <span class="kt">Just</span> <span class="n">q&#39;</span> <span class="ow">-&gt;</span>
              <span class="n">match</span> <span class="n">q&#39;</span> <span class="n">s</span>
</pre></div>
</div>
</body>
</html>
