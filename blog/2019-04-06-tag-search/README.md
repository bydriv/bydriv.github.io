# タグ検索と集合演算

いろいろなサービスにはいわゆる **タグ** という機能があることが多い。
たとえばコンテンツaがタグA,B,Cでタグつけされていることを a: A,B,C と表記してみる。
それで、こんな感じにタグつけられたコンテンツを検索したいとする:

- a: A, B
- b: B, C
- c: C

タグ A, B, C で検索したコンテンツの集合を query(A OR B OR C) = {a, b, c} とか表記することにする。
たとえば query(B) = {a, b}, query (A AND B) = {a}, query (B OR C) = {a, b, c}, query (B - A) = {b} である。
(B - A) は差集合を意味する。

*Note*: なお、補集合 query(NOT A) は実際には検索として意味をなさないほど大量にヒットするので実用的ではない。
query(B AND NOT A) のように「しぼりこみ」しなければ検索として使いものにならないので差集合はあれど補集合は実装しないというのが穏当なところかと思う。

ところでタグ A, B, C をそれぞれ A = {a}, B = {a, b}, C ={b, c} のような集合だと思えば query はほんとうにただの集合演算であることがわかると思う。

ところでデータベースでタグを表現したい場合はどうすればいいのだろう。
一般にデータベースには

- One-to-one
- One-to-many
- Many-to-many

のみっつの関係がある。

One-to-many で "a content has many tags" の関係にするなら、タグを集合として扱うためには以下のようなテーブルを用意し
tag にインデックスを張る。

*content table*:

| id | name |
|----|------|
| 1  | a    |
| 2  | b    |
| 3  | c    |

*tag table*:

| id | content_id | tag |
|----|------------|-----|
| 1  | 1          | A   |
| 2  | 1          | B   |
| 3  | 2          | B   |
| 4  | 2          | C   |
| 5  | 3          | C   |

*集合 A, B, C の構成*:

```
SELECT content_id FROM tags WHERE tag = 'A';
SELECT content_id FROM tags WHERE tag = 'B';
SELECT content_id FROM tags WHERE tag = 'C';
```

A, B, C が構成できればメモリ上で集合演算がおこなえる。
もちろん集合演算なので最適化の余地もあると思うが、今回は割愛。

## DynamoDB では

タグをつぎのように表すのが、たぶんいちばん直観的ではあるのだが:

*content table*:

| HashKey | name | tags   |
|---------|------|--------|
| 1       | a    | [A, B] |
| 2       | b    | [B, C] |
| 3       | c    | [C]    |

じつのところ、これでタグを検索できるようにするのは至難の業だと思う。

まず、配列には GSI を張れない(勘違いじゃないよね?)。
なので、「aに属するタグの集合」をとるのは簡単なのだが、「Aに属するコンテンツの集合」をとるのが難しい。

ハッシュキー(パーティションキー)には文字列か数値かバイナリしか使えないうえ、完全一致でしか検索できないので検索用の属性を配列にすべきではない。

よりよい設計としては、タグ用の関連テーブルをもうひとつ用意する:

*tag table*:

| HashKey | RangeKey |
|---------|----------|
| A       | a        |
| B       | a        |
| B       | b        |
| C       | b        |
| C       | c        |

もしくは、テーブルをひとつにまとめる原則を適用するなら、 prefix をつけてこういうふうにする:

*persistent table*: 

| HashKey   | RangeKey | name |
|-----------|----------|------|
| content#1 | _        | a    |
| content#2 | _        | b    |
| content#3 | _        | c    |
| tag#A     | a        |      |
| tag#B     | a        |      |
| tag#B     | b        |      |
| tag#C     | b        |      |
| tag#C     | c        |      |

これなら A, B, C の集合を構成するのが簡単になる。
