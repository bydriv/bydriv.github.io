---
url: https://bydriv.github.io/blog/2021-01-01/
title: bydriv.github.io
description: "純粋関数型グラフ - あるいはマンハッタン距離順序"
thumbnail: https://bydriv.github.io/etc/site/thumbnail.png
---

# 純粋関数型グラフ - あるいはマンハッタン距離順序

- *[プログラミング言語に標準で単射がほしいという話](../2020-12-12) の続き (？)*

あけましておめでとうございます。
去年からグラフや順序についていろいろと試行錯誤していたらいつの間にか年が明けてしまいました。
1 年の計はなんとやら。なにごとも出だしが重要というわけです（ほんまか）。
以前からグラフを扱うデータ構造に興味があっていろいろと考えていたのだけど、
どう頑張っても木の回転をうまく定義できず固定長のデータ構造として考えるのであればよいのですが、
動的に長さを変える用途に向いておらずデータ構造ではなく順序関係を最適化する方向に舵を切り
マンハッタン距離の 45 度回転に辿りつきました。
それを最近かなりうまく定義できた気がするので記事にしてみます。

## 動機と直観

まず最初に左から右も、右から左もひくことができるデータ構造がほしいという動機がある。
つまり `(Map a b, Map b a)` 相当の操作が可能なデータ構造である。

直観としてそのようなデータ構造は数学的には **二項関係** そのものである。
二項関係とは $A$ と $B$ の直積集合の部分集合 $G\subseteq{}A\times{}B$ の組であり、
$R=(A,B,G)$ と表される。ここで $G$ は **グラフ** と呼ばれ、
グラフと二項関係の違いは $A$ や $B$ という **始集合** (*domain*) や **終集合** (*codomain*) について
考えるかどうかである。たとえば写像 $f:A\rightarrow{}B$ は二項関係の特別な場合であり、
$f(x)=y$ となるような $(x,y)$ をすべて集めた $G=\{(x,y)\in{}A\times{}B|f(x)=y\}$ のようなグラフと考えることができる。
ここで $A$ を考えることで部分写像という概念を考えることができるようになる。

さて問題は高々可算の集合 $A$, $B$ およびそれらの
直積集合の部分集合 $G\subseteq{}A\times{}B$ からいかに $x\in{}A$ や $y\in{}B$ を
効率的に探索できるかという計算複雑性の問題に帰着できる。
$A$ が全順序集合だとすれば $x\in{}A$ を $O(log_2(n))$ で探索できるのだから、
$B$ や $A\times{}B$ が全順序集合となる場合を考えることは自然な発想である。
問題は $A\times{}B$ の全順序を定義するとき、 $x\in{}A$ の順序や $y\in{}B$ の順序だけで
$(x,y)\in{}A\times{}B$ の順序をある程度決定できる必要がある。
辞書順は $x\in{}A$ のみで $(x,y)\in{}A\times{}B$ の順序をほとんど決定できるが、
$y\in{}B$ の順序から探索することは困難である。

そのためのもっとも素朴な方法は $x$ が等しいものの同値類で $A\times{}B$ を割ってその同値類ごとに
二分探索することが考えられる。これは `Map a (Set b)` そのものだが、 $x$, $y$ の数をそれぞれ $n$, $m$ とすれば
$x$ から $y$ の探索は $O(log_2(n)+log_2(m)) = O(log_2(nm))$ で済む (関係の数の対数オーダー) 一方で
$y$ から $x$ の探索は $O(n log_2(m))$ となる。これは $n$ がとても小さな値の場合には問題にならないものの
一対一のような関係の場合、 $n=m$ となって $B$ から $A$ の探索は準線型オーダーとなるから、あまりよくない。
そうなると `(Map a (Set b), Map b (Set a))` とすればよいとなりこれは穏当な構造であるものの、
基本的に `Map` や `Set` というのは左から右をひいたりある要素があるかないかを判定するために特化した
データ構造であり、一対一の関係や多対多の関係を扱う場合、もっと最適な構造を考えることができるかもしれない。
たとえば今回は左から右、右から左をひくときに常に 1 要素で探索することを前提としているものの、
複数の要素が同時に属する関係を探索するなど、グラフを扱う場合はより複雑なことをする必要がある場合も多い。

さて大小関係を数直線として考えると、 1 要素の場合大小関係が単純な直線であるのに対して

$\cdots, x_{-2}, x_{-1}, x_0, x_1, x_2, \cdots$

2 要素の場合 2 次元の表になることがわかる。

|                    |                    |                 |                  |                 |
|--------------------|--------------------|-----------------|------------------|-----------------|
| $(x_{-2}, y_{-2})$ | $(x_{-1}, y_{-2})$ | $(x_0, y_{-2})$ | $(x_1, y_{-2})$  | $(x_2, y_{-2})$ |
| $(x_{-2}, y_{-1})$ | $(x_{-1}, y_{-1})$ | $(x_0, y_{-1})$ | $(x_1, y_{-1})$  | $(x_2, y_{-1})$ |
| $(x_{-2}, y_0)$    | $(x_{-1}, y_0)$    | $(x_0, y_0)$    | $(x_1, y_0)$     | $(x_2, y_0)$    |
| $(x_{-2}, y_1)$    | $(x_{-1}, y_1)$    | $(x_0, y_1)$    | $(x_1, y_1)$     | $(x_2, y_1)$    |
| $(x_{-2}, y_2)$    | $(x_{-1}, y_2)$    | $(x_0, y_2)$    | $(x_1, y_2)$     | $(x_2, y_2)$    |

ここでこのような表がつくれるという根拠は $A$, $B$ が **高々可算** であることに依拠している。
つまり自然数や整数で番号を振って離散的に並べることができるということである。
非可算集合の場合、このような表をつくることがそもそもできない。

直積の順序はいくつか異なる定義が考えられる。
プログラミング言語で一般的な順序は辞書順で、
これは $x$ 軸の順序を優先した順序である。
ほかの定義として **積順序** というものがありこれは

$(x,y)\leq(x',y')\Leftrightarrow{}x\leq{}x'\land{}y\leq{}y'$

で定義される大小関係である。
積順序の性質として、他方の順序のみで全体の順序を決定できるというものがある。
つまりもし仮にすべての要素が積順序で並んでいたとすれば、
$x$ だけでも $y$ だけでも二分探索が可能である。
その一方で積順序では比較不能なものは無数にある。
つまり積順序は全順序にはならず、半順序になる。
とはいえ積順序は左から右も、右から左もひくためのデータ構造に理想的な性質を持っている。

さて、そこで積順序で比較可能なものと比較不能なものについて考えよう。
ここでは表の対角線に着目する。つまり、先の表においてまず

|                    |                    |                 |               |              |
|--------------------|--------------------|-----------------|---------------|--------------|
| $(x_{-2}, y_{-2})$ |                    |                 |               |              |
|                    | $(x_{-1}, y_{-1})$ |                 |               |              |
|                    |                    | $(x_0, y_0)$    |               |              |
|                    |                    |                 | $(x_1, y_1)$  |              |
|                    |                    |                 |               | $(x_2, y_2)$ |

という対角線にについて考えると、これは明らかにすべて積順序で比較可能であることがわかる。
一方

|                 |                    |                 |                  |                 |
|-----------------|--------------------|-----------------|------------------|-----------------|
|                 |                    |                 |                  | $(x_2, y_{-2})$ |
|                 |                    |                 | $(x_1, y_{-1})$  |                 |
|                 |                    | $(x_0, y_0)$    |                  |                 |
|                 | $(x_{-1}, y_1)$    |                 |                  |                 |
| $(x_{-2}, y_2)$ |                    |                 |                  |                 |

という対角線について考えると、これはすべて積順序で比較不能である。

そこでこの表を 45 度回転させることで積順序を自然に線型順序拡大した全順序が得られる。
このような表を 45 度回転させるために好都合な道具があり、 **マンハッタン距離** と呼ばれる。

## 距離順序と距離空間

もし $x\in{}A$, $y\in{}B$ をその順序関係で並べた数直線上の整数と同一視できるのであれば、
$(x,y)\in{}G$ の要素はそれらの線分の直交座標系の点と捉えることができる。
そのためには通常の順序関係では力不足である。なぜなら通常の順序関係はふたつの要素が
ある数直線上においてより左側にあるかより右側にあるかまではわかるものの、
それらのあいだの距離はわからないからである。ベクトル空間で考えるのもよさそうだが、
順序を考える場合には、 2 次元や 3 次元の広がりをもつ空間よりは単なる直線であるほうが都合がよい。
全順序は **線型順序** とも言いこれは全順序であるものを並べると直線になるからだ。
そこで順序の距離というものを考えたい。

整数の距離は明らかであり、

$d(i,j)=|i-j|$

と定義できる。またこの距離は

- $i=j\Leftrightarrow{}d(i,j)=0$
- $d(i,j)=d(j,i)$
- $d(i,j)+d(j,k)\geq{}d(i,k)$
- $d(i,j)\geq{}0$

となるから、 **距離空間** (*metric space*) の公理を満たす。

またさらに強い性質

- $d(i,j)+d(j,k)=d(i,k)$

も満たすこともわかる。

全順序であり距離空間であるならば、その **向き** を考えることができる。
つまり

- $f(i,j) = d(i,j) \Leftrightarrow i \geq j$
- $f(i,j) = -d(i,j) \Leftrightarrow i < j$

と定義すればよい。順序を向き $d(i,j)$ を大きさとするならば $f(i,j)$ は
1 次元のベクトルそのものである。

そこで距離空間の公理を負の数を許容するように変えた公理系を考えることができる。

- $x=y\Leftrightarrow{}f(x,y)=0$
- $f(x,y)=-f(y,x)$
- $|f(x,y)|+|f(y,z)|\geq{}|f(x,z)|$
- $f(x,y)\geq{}0\land{}f(y,z)\geq{}0\Rightarrow{}f(x,z)\geq{}0$

これらの公理からただちに

- $f(x,y)\geq{}0\land{}f(y,z)\geq{}0\Rightarrow{}f(x,y)+f(y,z)\geq{}f(x,z)\geq{}0$

が証明できる。なんとなれば $f(x,y)\geq{}0\land{}f(y,z)\geq{}0$ であれば
$f(x,z)\geq{}0$ であり、 0 以上ならば絶対値の記号を外すことができるため

- $f(x,y)+f(y,z)\geq{}f(x,z)$

が出るからである。そしてこの定理からさらに

- $f(x,y)\leq{}0\land{}f(y,z)\leq{}0\Rightarrow{}f(x,y)+f(y,z)\leq{}f(x,z)\leq{}0$

が証明できる。
これは $f(x,y)=-f(y,x)$ は常に等しいから、符号を反転させれば常に
$f(x,y)\geq{}0\land{}f(y,z)\geq{}0\Rightarrow{}f(x,y)+f(y,z)\geq{}f(x,z)\geq{}0$
の関係に帰着させることができることによる。
従って

- $f(x,y)\leq{}0\land{}f(y,z)\leq{}0\Rightarrow{}f(x,z)\leq{}0$

である。

ここで

- $x\leq{}y\Leftrightarrow{}f(x,y)\leq{}0$

と定義することで全順序となるし、また

- $d(x,y)=|f(x,y)|$

とすることで距離空間となることもわかる。
よってこれを **距離順序** (*metric order*) と呼んで
$f$ を **距離順序関数** と呼び、今後はこれを公理と考えて進めよう。

*ただしこれは解釈の問題ではあるものの、順序を考えずに
単なる距離に向きがある距離空間であると解釈したほうがすっきりする。
言うなれば相対距離空間であろうか。当初の動機は順序の距離を考えることであったので
この記事では距離順序と呼んでいるものの、いろいろと考えるうちにもうすこし
一般化して相対距離空間と呼んだほうが妥当な気がする。*

さて距離順序の公理は明らかに距離空間の公理よりも強いので、距離空間の公理は満たす。つまり

- $x=y\Leftrightarrow{}d(x,y)=0$ (距離順序の公理より)
- $d(x,y)=d(y,x)$ (絶対値をとっているので明らか)
- $d(x,y)+d(x,z)\geq{}d(x,z)$ (距離順序の公理より)
- $d(x,y)\geq{}0$ (絶対値をとっているので明らか)

一方でこれが全順序になることはそこまで自明でもなくきちんと証明しておこう。

**定理** $x\leq{}y$ かつ $y\leq{}x$ ならば $x=y$

**証明** $x\leq{}y\Leftrightarrow{}f(x,y)\leq{}0$ かつ
$y\leq{}x\Leftrightarrow{}f(y,x)\leq{}0$ であり
$f(y,x)=-f(x,y)$ であるから
$f(x,y)\leq{}0$ かつ $-f(x,y)\leq{}0$ である。
ゆえに $f(x,y)=0\Leftrightarrow{}x=y$
∎

**定理** $x\leq{}y$ かつ $y\leq{}z$ ならば $x\leq{}z$

**証明** $x\leq{}y\Leftrightarrow{}f(x,y)\leq{}0$ かつ
$y\leq{}z\Leftrightarrow{}f(y,z)\leq{}0$ である。

$f(x,y)=-f(y,x)$ かつ $f(y,z)=-f(z,y)$ であり $f(y,x)\geq{}0$ かつ $f(z,y)\geq{}0$ である。
$f(z,y)\geq{}0\land{}f(y,x)\geq{}0\Rightarrow{}f(z,x)\geq{}0$ である。

$f(z,x)=-f(x,z)$ であり $f(x,z)\leq{}0$ である。
ゆえに $f(x,z)\leq{}0\Leftrightarrow{}x\leq{}z$
∎

**定理** $x\leq{}y$ または $y\leq{}x$

**証明** $x\leq{}y\Leftrightarrow{}f(x,y)\leq{}0$ かつ
$y\leq{}x\Leftrightarrow{}f(y,x)\leq{}0$ であり
$f(y,x)=-f(x,y)$ であるから $f(x,y)\leq{}0\Leftrightarrow{}x\leq{}y$ または $-f(x,y)\leq{}0\Leftrightarrow{}y\leq{}x$
∎

さて整数の差は自明な距離順序となる。
つまり

$f(i,j)=i-j$

と置くと、これは

- $x=y\Leftrightarrow{}f(x,y)=0$
- $f(x,y)=-f(y,x)$
- $|f(x,y)|+|f(y,z)|\geq{}|f(x,z)|$
- $f(x,y)\geq{}0\land{}f(y,z)\geq{}0\Rightarrow{}f(x,z)\geq{}0$

のいずれも満たすことがわかる。

同じことが有理数にも言える。
自然数の場合には負を扱うことができないので、
一旦整数を経由して定義することになる。

ところでほとんどのプログラミング言語で扱えるプリミティブ型は (`Float` だとか `Double` だとかも含めて)
有理数に変換できるので有理数を経由することでだいたいなんでも距離順序にできる。

*実際コンピュータは機械語やアセンブリのレベルでは整数の差をもって大小関係を判定しているのであり
これは自然な事実であろう。そのとき単なる符号だけでなくその絶対値も考えることで直積のような
2 次元の順序を考える場合に都合がよいということである。*

また整数や有理数の場合、さらに強い性質

- $f(x,y)+f(y,z)=f(x,z)$

も満たすこともわかる。このような性質をもつ距離順序を考えると都合がいいのでこれを
**線型距離順序** と呼ぼう。

さてありとあらゆる全順序関係は

- $f(x,y)=-1 \Leftrightarrow x<y$
- $f(x,y)=0 \Leftrightarrow x=y$
- $f(x,y)=1 \Leftrightarrow x>y$

と置くことでその順序を整数に写す写像を定義でき、距離順序となる。

## マンハッタン距離順序と積順序

さてマンハッタン距離について考えよう。
マンハッタン距離とは点 $p = (x, y)$ と $q = (x', y')$ が与えられたとき
$d((x,y),(x',y'))=|x-x'|+|y-y'|$ と定義される距離である。
これは距離空間をなす。

さてそのうえで符号を許容するようにマンハッタン距離順序を考えたい。
マンハッタン距離（というか格子状の座標系）は 45 度回転させる操作が簡単で

- $g((x,y),(x',y'))=((x-x')+(y-y'), (x-x')-(y-y'))$

と定義できる。これは点 $(x,y)$ と $(x',y')$ の相対座標を
45 度回転させた相対座標を得ることができる。
$+$ と $-$ を入れ替えれば回転する方向を変えることができる。

一般に垂直もしくは水平に移動するとマンハッタン距離は $1$ ずつ増減するのに対し
対角線の方向に移動するとマンハッタン距離は $2$ ずつ増減するため、
格子状の座標系では垂直もしくは水平に配置されたものを対角線に配置すると、
ぞのマンハッタン距離は $2$ 倍になる。

この回転させた点を **辞書式順序** で並べることで自然な全順序関係を得ることができる。
距離を考えない場合にはそれでもいいものの、あくまで距離順序とするのであれば、
距離の概念もあわせて考えておこう。そのようにすることで距離順序の距離順序というような
概念も考えることができて都合がいいからである。

さて $g$ の定義のうち

- $g((x,y),(x',y'))=((x-x')+(y-y'), (x-x')-(y-y'))$

$x-x'$ や $y-y'$ という部分は距離順序であり、これは任意の距離順序に一般化し

- $g((x,y),(x',y'))=(f(x,x')+f(y,y'), f(x,x')-f(y,y'))$

と置き換えてしまおう。そこで

- $f(p,q)=sgn(x)(|x|+|y|) \Leftrightarrow (x,y)=g(p,q) \land sgn(x)\neq{}0$
- $f(p,q)=sgn(y)(|x|+|y|) \Leftrightarrow (x,y)=g(p,q) \land sgn(x)=0$

と定義し、これが距離順序の公理を満たすことを証明しよう。

なおここで $sgn(x)$ ではなく $sgn(y)$ を優先する定義も考えられその場合には
対角線の確度の向きが変わる。それは $x\leq{}x'\land{}y\geq{}y'$ のように
順序が反変する関係のものを優先して並べるようになるのでこれを別の定義と捉える場合には
**共変マンハッタン距離順序** や **反変マンハッタン距離順序** と呼ぼう。

ここで $p=(x,y)$ や $q=(x',y')$ や $r=(x'',y'')$ と表すことにする。

**定理** $p=q\Leftrightarrow{}f(p,q)=0$

**証明**

- まず $p=q\Rightarrow{}f(p,q)=0$ を証明する。
  $f(x,x')=0$ かつ $f(y,y')=0$ であり $g(p,q)=0$ であるから $f(p,q)=0$
- 次に $p=q\Leftarrow{}f(p,q)=0$ を証明する。
    - $sgn(x)\neq{}0$ の場合。 $|x|+|y|\neq{}0$ であり $f(p,q)\neq{}0$ であるから前提と矛盾する。
    - $sgn(x)=0$ の場合。 $sgn(y)\neq{}0$ と仮定すれば $|x|+|y|\neq{}0$ であり
      $f(p,q)\neq{}0$ であるから前提と矛盾する。
      よって $sgn(y)=0$ であり、 $sgn(x)=0$ かつ $sgn(y)=0$ なので $g(p,q)=(0,0)$ である。
      $g$ の定義を見れば
      $fst(g(p,q))=0$ となるのはある $k$ が存在して $f(x,x')=k$ かつ $f(y,y')=-k$ となる場合のみであり、さらに
      $snd(g(p,q))=0$ となるのはそれと同じ $k$ について $f(x,x')=k$ かつ $f(y,y')=k$ となる場合のみであるとわかる。
      ここで $f(y,y')=-k$ かつ $f(y,y')=k$ となる $k$ は $0$ のみであるから $k=0$ である。
      よって $x=x'\Leftrightarrow{}f(x,x')=0$ かつ $y=y'\Leftrightarrow{}f(y,y')=0$ であり $p=q$
∎

**定理** $f(p,q)=-f(q,p)$

**証明** まず $(x,y)=p,(x',y')=q$ と置く。
公理より $f(x',x)=-f(x,x')$ かつ $f(y',y)=-f(y,y')$ であるから

- $g(p,q)=(f(x,x')+f(y,y'),f(x,x')-f(y,y'))$
- $g(q,p)=(f(x',x)+f(y',y),f(x',x)-f(y',y))=((-f(x,x'))+(-f(y,y')),(-f(x,x'))-(-f(y,y')))$

である。式を整理すれば $g(q,p)=(-(f(x,x')+f(y,y')),-(f(x,x')-f(y,y')))$ となる。

ここで $g(p,q)=(f(x,x')+f(y,y'),f(x,x')-f(y,y'))$ であるから
$(x_1,y_1)=g(p,q),(x_2,y_2)=g(q,p)$ と置けば $x_1=-x_2$ かつ $y_1=-y_2$ とわかる。
さてここで $f$ の定義を見れば $|f(p,q)|=|x_1|+|y_1|=|x_2|+|y_2|=|f(q,p)|$ であり、
その絶対値は等しい。そして $sgn(x_1)=-sgn(x_2)$ かつ $sgn(y_1)=-sgn(y_2)$ であるから
符号もちょうど反転した関係にある。また符号が反転しても場合分けでの定義は変わらない。
よって $f(p,q)=-f(q,p)$
∎

**定理** $|f(p,q)|+|f(q,r)|\geq{}|f(p,r)|$

**証明** $(x_1,y_1)=g(p,q)$ かつ $(x_2,y_2)=g(q,r)$ かつ
$(x_3,y_3)=g(p,r)$ と置くと $|f(p,q)|=|x_1|+|y_1|$,
$|f(q,r)|=|x_2|+|y_2|$, $|f(p,r)|=|x_3|+|y_3|$ と表せる。
ここで $x_1=f(x,x')+f(y,y')$,
$x_2=f(x',x'')+f(y',y'')$,
$x_3=f(x,x'')+f(y,y'')$,
$y_1=f(x,x')-f(y,y')$,
$y_2=f(x',x'')-f(y',y'')$,
$y_3=f(x,x'')-f(y,y'')$ であって、絶対値の大小関係を示すには
単に 2 乗すればよい。すなわち

- $|x_1|^2+|y_1|^2=(f(x,x')+f(y,y'))^2+(f(x,x')-f(y,y'))^2$
- $|x_2|^2+|y_2|^2=(f(x',x'')+f(y',y''))^2+(f(x',x'')-f(y',y''))^2$
- $|x_3|^2+|y_3|^2=(f(x,x'')+f(y,y''))^2+(f(x,x'')-f(y,y''))^2$

の大小関係さえ調べればよい。

このうち $|f(x,x')|+|f(x',x'')|\geq{}|f(x,x'')|$ および
$|f(y,y')|+|f(y',y'')|\geq{}|f(y,y'')|$ は距離順序の公理より成り立ち、
これはその和や差や累乗のみからなる式であるからやはり大小関係はなりたつ。
従って $|x_1|+|y_1|+|x_2|+|y_2|\geq{}|x_3|+|y_3|$ である。
ゆえに $|f(p,q)|+|f(q,r)|\geq{}|f(p,r)|$
∎

さて次に $f(p,q)\geq{}0\land{}f(q,r)\geq{}0\Rightarrow{}f(p,r)\geq{}0$ という
命題について考えてみよう。

**命題** $f(p,q)\geq{}0\land{}f(q,r)\geq{}0\Rightarrow{}f(p,r)\geq{}0$

これがが成り立つためには符号が反転しない必要がある。 $g$ の定義のうち

- $g(p,q)=g((x,y),(x',y'))=(f(x,x')+f(y,y'), f(x,x')-f(y,y'))$
- $g(q,r)=g((x',y'),(x'',y''))=(f(x',x'')+f(y',y''), f(x',x'')-f(y',y''))$
- $g(p,r)=g((x,y),(x'',y''))=(f(x,x'')+f(y,y''), f(x,x'')-f(y,y''))$

という部分に着目すると、 $f$ の増加量が異なるとグラフにしたときにある点を境に
符号が反転してしまうことがわかる。距離順序の公理には増加量に関する定義がないため、
一般にこの命題は成り立たない。そこで距離順序をもうすこし強めた公理系が必要である。

もし整数のような性質をもつ距離順序の場合にはこの性質が成り立つことが容易に確かめられる。
そこで今回は

- $f(x,x')+f(x',x'')=f(x,x'')$
- $f(y,y')+f(y',y'')=f(y,y'')$

を仮定したい。

**定理** $f(p,q)\geq{}0\land{}f(q,r)\geq{}0\Rightarrow{}f(p,r)\geq{}0$

**証明**

- $g(p,q)=g((x,y),(x',y'))=(f(x,x')+f(y,y'), f(x,x')-f(y,y'))$
- $g(q,r)=g((x',y'),(x'',y''))=(f(x',x'')+f(y',y''), f(x',x'')-f(y',y''))$
- $g(p,r)=g((x,y),(x'',y''))=(f(x,x'')+f(y,y''), f(x,x'')-f(y,y''))$

であり、その符号は

- $x_1=f(x,x')+f(y,y')$
- $y_1=f(x,x')-f(y,y')$
- $x_2=f(x',x'')+f(y',y'')$
- $y_2=f(x',x'')-f(y',y'')$
- $x_3=f(x,x'')+f(y,y'')$
- $y_3=f(x,x'')-f(y,y'')$

によって与えられる。仮定より $f(p,q)\geq{}0$ かつ $f(q,r)\geq{}0$ である。
このとき、とくに $x_1\geq{}0$ かつ $x_2\geq{}0$ である。
さて $x_3=x_1+x_2$ であるから $x_3\geq{}0$ である。
$x_3>0$ であればよい。 $x_3=0$ の場合 $x_1=0$ かつ $x_2=0$ であるから
$y_1\geq{}0$ かつ $y_2\geq{}0$ である。
さてこの場合でも $y_3=y_1+y_2$ であるから $y_3\geq{}0$ である。
ゆえに $f(p,q)\geq{}0$
∎

この証明では等式であるためその和が常に 0 よりも大きいことは簡単に確かめられた。
一方で不等式の場合、 $x_1\geq{}0$ かつ $x_2\geq{}0$ を仮定しても
$x_3\geq{}0$ を言うのは簡単なことではない。もし
$x_1\geq{}0$ と $x_2\geq{}0$ とが負と正の数の和でもって表されていて
たまたま合計で正になっている場合、三角不等式では増加量に関する性質をなにも
言えないため、 $x_3\geq{}0$ が正になるか負になるかはまったくでたらめになってしまう。
ただもしもそれぞれの距離順序がなんらかの単位でその増加量が制限されていたならば、
その増加量がいくら変化しても正負が反転しないことが証明できるかもしれない。

さてこのように定めた順序関係は通常の積順序の **線型順序拡大** になっている。
つまり積順序で $(x,y)\leq{}(x',y')$ ならば (共変) マンハッタン距離順序でも
$(x,y)\leq{}(x',y')$ である。

ところで **辞書式順序** と呼ばれる直積の順序を
距離順序で定めるためには右の要素数が有限であってその数を知ることができるか、
もしくは **無限の距離** というものを考える必要がある。
一方で対角線の長さでの順序は、要素数を知らずとも定義できるという性質がある。

またマンハッタン距離におけるおもしろい性質として積順序で
$A\times{}B$ が稠密でない高々可算の集合であって

$(x_1,y_1)\leq{}(x'_n,y'_m)$ であって $d((x_1,y_1),(x'_n,y'_m))=n+m-1$

のとき

$(x_1,y_1)<(x_1,y_2)<(x_2,y_2)<\cdots<(x'_n,y'_m)$

と推移律をたどって隙間なく並べたとき、

$G=\{(x_1,y_1),(x_1,y_2),(x_2,y_2),\cdots,(x'_n,y'_m)\}$

という有限集合を考えると $|G|=n+m$ となる。
つまり積順序が全順序となるよう比較可能なものをできるだけたくさん集めた
$G\subseteq{}A\times{}B$ という部分集合において
$A$, $B$ の距離関数がその区間の元の個数を表すとき、
マンハッタン距離は積順序が全順序となりうる $A\times{}B$ の部分集合の元の個数の最大値から
$1$ をひいた数に等しい。

## 実装と形式化、および今後の展望

まだ途中ではあるもののこの直観に基づいて二分木を定義できないかいろいろと模索している。
実際に動く Haskell 実装と Coq による形式化が現在 [Lemma](../../misc/lemma) にある。
このように定義した二分木は $(x,y)$ の組が与えられた場合には通常の二分木と同様の性能を発揮し、
$x$ か $y$ かのいずれか一方が与えられた場合には、 75% の要素に関しては $O(log_2(n))$ で探索できるものの、
25% の外れ値 (存在しない場合も含む) の最悪計算量は $O(n)$ となる。
ただし外れ値が存在しないことが判定できれば $O(log_2(n))$ で探索が可能であり、
そのために距離の概念を使うことができる。具体的にはたとえば $y_1 \leq y \leq y_2$ となるような
範囲を指定したり、あるいは最大限と最小限を記録しておくことで高速な探索が可能になる。

基本的なアイディアは順序関係を最適化することでうまく直積を二分探索できないかというものなので、
データ構造としてはマンハッタン距離順序を順序関係とする赤黒木など、
ありとあらゆる二分木や二分探索などのデータ構造やアルゴリズムに応用できる。

また目下最大の問題は複数の距離順序間の増加量が一致しない場合に順序がまったくでたらめになってしまうことであり、
実装としては一応は動くものの、理論的な性質があまりよくない。
この問題に関してはベクトル空間における **基底** の概念を追加すればよいのではないかと考えている。
つまり問題の根本は複数の座標系における基底変換をするための情報が与えられていないことによるのではないか、
というのはまだ直観の段階ではあるものの。
*「すべての道は線型代数に通ずる」ンッン～名言だなこれは。*

また三角不等式は上から抑えることができないので (理論的な) 問題が起きているとも言える。
実装としてはまあ問題ないことも多い。実際マンハッタン距離順序の場合でも無制限に距離が伸びるのではなく、
実際には高々 2 倍（だよね？）の距離に収まる。
これを考えると 1 次元においては高々 1 倍の距離に収まり
2 次元においては高々 2 倍の距離に収まりという類推は効く。
もちろんまだ直観の段階なのでなんの準備もできていない。

また直積だけでなく直和の距離順序についても検討中ではあるものの、
これについてはまだわたしのなかでは答えが出ていない。
実装として `Either a b` を `Metric` の instance にはしてあるものの、
この定義でいいのかまったく自信がないのである。もちろん全順序にはなっていて
プログラムとして問題なく動作はする。とはいえその性質に関してわたしはまだなにもわかっていない。
たとえばこのように定義した `Either a b` を要素とするような直積のマンハッタン距離順序は仮定が
異なっているためいまのところ、わたしにもまったく動作が予測できない。
ひょっとしたらうまく動作するのかもしれないし、ぜんぜんでたらめな動作をするかもしれない。
このようなマンハッタン距離順序の動作は (いまのところ) まったく不定である。
