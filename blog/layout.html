<!DOCTYPE html>
<html>
<head>
<title>Layout ルール， Haskell のオフサイドルールについて</title>
<!-- 2018-01-19 Fri 16:33 -->
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="/css/prelude.css" />
<link rel="stylesheet" type="text/css" href="/css/highlight.css" />
</head>
<body>
<div id="content">
<h1 class="title">Layout ルール， Haskell のオフサイドルールについて</h1>
<div class="location">
<p>
https://<a href="/">bydriv.github.io</a>/<a href="/blog">blog</a>/<strong>layout.html</strong>
</p>

</div>

<div class="created_at">
<p>
created at <time datetime="2018-01-19">2018-01-19</time>
</p>

</div>

<div class="updated_at">
<p>
updated at <time datetime="2018-01-19">2018-01-19</time>
</p>

</div>

<p>
周知のとおり， Haskell はいわゆるインデントでブロックを表す，
オフサイドルールを採用した言語である．
しかしながら， どこでどの程度インデントすればよいのかについては，
みんななんとなく雰囲気で書いているようである．
じつはこれについては Haskell 2010 で厳格に定義されており， Layout と呼ばれている．
Layout は， 簡単にいえば特定の箇所に <code>{</code>, <code>}</code>, <code>;</code> などを自動的に挿入する仕組みで，
字句解析のあと，　構文解析のまえに処理される．
<a href="https://www.haskell.org/onlinereport/haskell2010/haskellch2.html#x7-210002.7">2.7 Layout</a> から引用すると，
</p>

<div class="highlight"><pre><span class="kr">module</span> <span class="nn">AStack</span><span class="p">(</span> <span class="kt">Stack</span><span class="p">,</span> <span class="n">push</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">size</span> <span class="p">)</span> <span class="kr">where</span>
<span class="kr">data</span> <span class="kt">Stack</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">Empty</span>
             <span class="o">|</span> <span class="kt">MkStack</span> <span class="n">a</span> <span class="p">(</span><span class="kt">Stack</span> <span class="n">a</span><span class="p">)</span>

<span class="nf">push</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Stack</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Stack</span> <span class="n">a</span>
<span class="nf">push</span> <span class="n">x</span> <span class="n">s</span> <span class="ow">=</span> <span class="kt">MkStack</span> <span class="n">x</span> <span class="n">s</span>

<span class="nf">size</span> <span class="ow">::</span> <span class="kt">Stack</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Int</span>
<span class="nf">size</span> <span class="n">s</span> <span class="ow">=</span> <span class="n">length</span> <span class="p">(</span><span class="n">stkToLst</span> <span class="n">s</span><span class="p">)</span>  <span class="kr">where</span>
           <span class="n">stkToLst</span>  <span class="kt">Empty</span>         <span class="ow">=</span> <span class="kt">[]</span>
           <span class="n">stkToLst</span> <span class="p">(</span><span class="kt">MkStack</span> <span class="n">x</span> <span class="n">s</span><span class="p">)</span>  <span class="ow">=</span> <span class="n">x</span><span class="kt">:</span><span class="n">xs</span> <span class="kr">where</span> <span class="n">xs</span> <span class="ow">=</span> <span class="n">stkToLst</span> <span class="n">s</span>

<span class="nf">pop</span> <span class="ow">::</span> <span class="kt">Stack</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="kt">Stack</span> <span class="n">a</span><span class="p">)</span>
<span class="nf">pop</span> <span class="p">(</span><span class="kt">MkStack</span> <span class="n">x</span> <span class="n">s</span><span class="p">)</span>
  <span class="ow">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kr">case</span> <span class="n">s</span> <span class="kr">of</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">i</span> <span class="n">r</span> <span class="kr">where</span> <span class="n">i</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">x</span><span class="p">)</span> <span class="c1">-- (pop Empty) is an error</span>

<span class="nf">top</span> <span class="ow">::</span> <span class="kt">Stack</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
<span class="nf">top</span> <span class="p">(</span><span class="kt">MkStack</span> <span class="n">x</span> <span class="n">s</span><span class="p">)</span> <span class="ow">=</span> <span class="n">x</span>                     <span class="c1">-- (top Empty) is an error</span>
</pre></div>

<p>
というプログラムは， 字句解析されたあと，
Layout ルールによって次のような字句列に変更される．
</p>

<div class="highlight"><pre><span class="kr">module</span> <span class="nn">AStack</span><span class="p">(</span> <span class="kt">Stack</span><span class="p">,</span> <span class="n">push</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">size</span> <span class="p">)</span> <span class="kr">where</span>
<span class="p">{</span><span class="kr">data</span> <span class="kt">Stack</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">Empty</span>
             <span class="o">|</span> <span class="kt">MkStack</span> <span class="n">a</span> <span class="p">(</span><span class="kt">Stack</span> <span class="n">a</span><span class="p">)</span>

<span class="p">;</span><span class="n">push</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Stack</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Stack</span> <span class="n">a</span>
<span class="p">;</span><span class="n">push</span> <span class="n">x</span> <span class="n">s</span> <span class="ow">=</span> <span class="kt">MkStack</span> <span class="n">x</span> <span class="n">s</span>

<span class="p">;</span><span class="n">size</span> <span class="ow">::</span> <span class="kt">Stack</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Int</span>
<span class="p">;</span><span class="n">size</span> <span class="n">s</span> <span class="ow">=</span> <span class="n">length</span> <span class="p">(</span><span class="n">stkToLst</span> <span class="n">s</span><span class="p">)</span>  <span class="kr">where</span>
           <span class="p">{</span><span class="n">stkToLst</span>  <span class="kt">Empty</span>         <span class="ow">=</span> <span class="kt">[]</span>
           <span class="p">;</span><span class="n">stkToLst</span> <span class="p">(</span><span class="kt">MkStack</span> <span class="n">x</span> <span class="n">s</span><span class="p">)</span>  <span class="ow">=</span> <span class="n">x</span><span class="kt">:</span><span class="n">xs</span> <span class="kr">where</span> <span class="p">{</span><span class="n">xs</span> <span class="ow">=</span> <span class="n">stkToLst</span> <span class="n">s</span>

<span class="p">}};</span><span class="n">pop</span> <span class="ow">::</span> <span class="kt">Stack</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="kt">Stack</span> <span class="n">a</span><span class="p">)</span>
<span class="p">;</span><span class="n">pop</span> <span class="p">(</span><span class="kt">MkStack</span> <span class="n">x</span> <span class="n">s</span><span class="p">)</span>
  <span class="ow">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kr">case</span> <span class="n">s</span> <span class="kr">of</span> <span class="p">{</span><span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">i</span> <span class="n">r</span> <span class="kr">where</span> <span class="p">{</span><span class="n">i</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">x</span><span class="p">}})</span> <span class="c1">-- (pop Empty) is an error</span>

<span class="p">;</span><span class="n">top</span> <span class="ow">::</span> <span class="kt">Stack</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
<span class="p">;</span><span class="n">top</span> <span class="p">(</span><span class="kt">MkStack</span> <span class="n">x</span> <span class="n">s</span><span class="p">)</span> <span class="ow">=</span> <span class="n">x</span>                        <span class="c1">-- (top Empty) is an error</span>
<span class="p">}</span>
</pre></div>

<p>
構文解析器はこの字句列を構文解析する．
したがって， 構文解析の段階ではもはや，
処理系がオフサイドルールを気にする必要はない．
</p>

<p>
<a href="https://www.haskell.org/onlinereport/haskell2010/haskellch10.html#x17-17800010.3">10.3 Layout</a> では， Layout ルールの詳細が述べられている．
厳密には参考文献を参照してほしいが，
あえて概説するなら，
<code>let</code>, <code>where</code>, <code>do</code>, <code>of</code> キーワードの <b>直後のトークン</b>
または <b>ファイル先頭のトークン</b> が <code>{</code> <b>でない</b> 場合，
<b>そのトークンの高さ</b> を基準に <code>{</code>, <code>}</code>, <code>;</code> を適宜挿入する．
たとえば， <code>let x = ...</code> というようなコードを見た場合，
処理系は <code>x</code> を基準として，
</p>

<ul class="org-ul">
<li><code>x</code> の直前に <code>{</code> を挿入する
</li>
<li><code>x</code> と同じ高さのトークンが現れた場合，その直前に <code>;</code> を挿入する
</li>
<li><code>x</code> より浅い高さのトークンが現れた場合，その直前に <code>}</code> を挿入する
</li>
</ul>

<p>
というふるまいをする． この基本を理解していれば，
インデントの深さが原因で起こる不可解な構文エラーに悩むことはなくなるはずである．
</p>

<p>
なお， Haskell をあまり書かないひとにはよく勘違いされているようだが，
Haskell は <code>{</code>, <code>}</code>, <code>;</code> を明示して書くこともできる．
F# の冗語構文と軽量構文みたいな感じである．
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">References</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>2.7 Layout <a href="https://www.haskell.org/onlinereport/haskell2010/haskellch2.html#x7-210002.7">https://www.haskell.org/onlinereport/haskell2010/haskellch2.html#x7-210002.7</a>
</li>
<li>10.3. Layout <a href="https://www.haskell.org/onlinereport/haskell2010/haskellch10.html#x17-17800010.3">https://www.haskell.org/onlinereport/haskell2010/haskellch10.html#x17-17800010.3</a>
</li>
</ul>
</div>
</div>
</div>
</body>
</html>
