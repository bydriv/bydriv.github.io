<!DOCTYPE html>

<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:url" content="https://bydriv.github.io/note/tree-of-hilbert-curve/">
  <meta property="og:type" content="article">
  <meta property="og:title" content="ヒルベルト曲線を用いた二分探索木について">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="bydriv.github.io">
  <meta property="og:image" content="https://bydriv.github.io/site/thumbnail.png">
  <meta name="twitter:card" content="summary_large_image">

  <title>ヒルベルト曲線を用いた二分探索木について</title>

  <link rel="stylesheet" type="text/css" href="/site/index.css">
  <script type="text/javascript" src="/site/index.js"></script>
</head>

<div class="tapestry">
  <div class="top left layer" data-height="-1">
    <article class="vertical component" data-route="/note/tree-of-hilbert-curve/" data-loaded="true" data-title="ヒルベルト曲線を用いた二分探索木について" data-scrollbar="none" data-visible="true">
<h1>ヒルベルト曲線を用いた二分探索木について</h1>
<h2>はしがき</h2>
<p>　二分探索木は線型の（一次元の直線状に並べることができる）データを扱うのに適したデータ構造で、たとえば Map a b といった構造を実装するためにもちいられます。さて Map a b は一般に a から b を探索することは効率的にできる一方、 b から a を探索することは不得手です。これは (a, b) といった二次元のデータというものは、一般に並べると直線ではなく表になるためです。そこで二次元の表を一次元の直線に変換してから扱う方法として空間充填曲線を用いるものがあります。ここではヒルベルト曲線を扱う方法を紹介します。</p>
<p align="right">
(2021-10-31)
</p>
<h2>ヒルベルト曲線とは</h2>
<p>　空間充填曲線と呼ばれる曲線のひとつで、たとえば以下のような形状をしています。またこれが再帰的に繰り返されます。</p>
<p><img src="hilbert.svg"></p>
<p>　プログラムでは以下のように平面上の座標 (x, y) をとって直線上の座標に写す関数として定義することができます。</p>
<pre><code><span class="nf">curve</span> <span class="ow">::</span> <span class="kt">Integral</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span>
<span class="nf">curve</span> <span class="n">n</span> <span class="n">x</span> <span class="n">y</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span>  <span class="mi">0</span>                             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;n must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">0</span>                             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;x must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span>                             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;x must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="n">n</span><span class="p">))</span> <span class="o">/=</span> <span class="mi">1</span>   <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator x must be a divisor of 2^n.&quot;</span>
  <span class="o">|</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">0</span>                             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;y must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span>                             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;y must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="n">n</span><span class="p">))</span> <span class="o">/=</span> <span class="mi">1</span>   <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator y must be a divisor of 2^n.&quot;</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span>                             <span class="ow">=</span> <span class="mi">0</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">curve</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>     <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>           <span class="o">/</span> <span class="mi">4</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">curve</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>     <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>       <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">curve</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">curve</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>       <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">%</span> <span class="mi">4</span>
  <span class="kr">where</span> <span class="n">m</span> <span class="ow">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<p>　たとえば上記の例ですと、つぎのように一辺が 2⁴ の長さの正方形の座標に順序を与えることができます。</p>
<pre><code>> let xys :: [(Int, Int)]
|     xys = map fst $ List.sortBy (\a b -> compare (snd a) (snd b))
|             [((x, y), curve 4 (x % 16) (y % 16)) | x <- [0..15], y <- [0..15]]
|
> print xys
[(0,0),(1,0),(1,1),(0,1),(0,2),(0,3),(1,3),(1,2),(2,2),(2,3),(3,3),(3,2),(3,1),(2,1),(2,0),(3,0),(4,0),(4,1),(5,1),(5,0),(6,0),(7,0),(7,1),(6,1),(6,2),(7,2),(7,3),(6,3),(5,3),(5,2),(4,2),(4,3),(4,4),(4,5),(5,5),(5,4),(6,4),(7,4),(7,5),(6,5),(6,6),(7,6),(7,7),(6,7),(5,7),(5,6),(4,6),(4,7),(3,7),(2,7),(2,6),(3,6),(3,5),(3,4),(2,4),(2,5),(1,5),(1,4),(0,4),(0,5),(0,6),(1,6),(1,7),(0,7),(0,8),(0,9),(1,9),(1,8),(2,8),(3,8),(3,9),(2,9),(2,10),(3,10),(3,11),(2,11),(1,11),(1,10),(0,10),(0,11),(0,12),(1,12),(1,13),(0,13),(0,14),(0,15),(1,15),(1,14),(2,14),(2,15),(3,15),(3,14),(3,13),(2,13),(2,12),(3,12),(4,12),(5,12),(5,13),(4,13),(4,14),(4,15),(5,15),(5,14),(6,14),(6,15),(7,15),(7,14),(7,13),(6,13),(6,12),(7,12),(7,11),(7,10),(6,10),(6,11),(5,11),(4,11),(4,10),(5,10),(5,9),(4,9),(4,8),(5,8),(6,8),(6,9),(7,9),(7,8),(8,8),(8,9),(9,9),(9,8),(10,8),(11,8),(11,9),(10,9),(10,10),(11,10),(11,11),(10,11),(9,11),(9,10),(8,10),(8,11),(8,12),(9,12),(9,13),(8,13),(8,14),(8,15),(9,15),(9,14),(10,14),(10,15),(11,15),(11,14),(11,13),(10,13),(10,12),(11,12),(12,12),(13,12),(13,13),(12,13),(12,14),(12,15),(13,15),(13,14),(14,14),(14,15),(15,15),(15,14),(15,13),(14,13),(14,12),(15,12),(15,11),(15,10),(14,10),(14,11),(13,11),(12,11),(12,10),(13,10),(13,9),(12,9),(12,8),(13,8),(14,8),(14,9),(15,9),(15,8),(15,7),(14,7),(14,6),(15,6),(15,5),(15,4),(14,4),(14,5),(13,5),(13,4),(12,4),(12,5),(12,6),(13,6),(13,7),(12,7),(11,7),(11,6),(10,6),(10,7),(9,7),(8,7),(8,6),(9,6),(9,5),(8,5),(8,4),(9,4),(10,4),(10,5),(11,5),(11,4),(11,3),(11,2),(10,2),(10,3),(9,3),(8,3),(8,2),(9,2),(9,1),(8,1),(8,0),(9,0),(10,0),(10,1),(11,1),(11,0),(12,0),(13,0),(13,1),(12,1),(12,2),(12,3),(13,3),(13,2),(14,2),(14,3),(15,3),(15,2),(15,1),(14,1),(14,0),(15,0)]
</code></pre>
<p>　ヒルベルト曲線にかぎりませんが、多くの空間充填曲線は上記のような離散的な曲線の極限をとって構成されます。プログラムで扱う場合にはこの離散的な曲線のまま扱うほうがなにかと都合がよいため、 2ⁿ の大きさの表を考えて、そのセルにヒルベルト曲線で順序をつけたうえで二分探索木で処理するようにします。まずは 2ⁿ の数値のみを扱うように構成し、ほかの値はハッシュ関数で 2ⁿ のハッシュ値に mapping して扱います。</p>
<p>　さてこれにて二分探索木で (x, y) を扱うためには m = curve n (hash x) (hash y) を求めればよいことがわかりました。しかしこのままでは探索時にも (x, y) の両方が必要で、 x のみや y のみが与えられたときに探索する方法がわかりません。</p>
<p>　ふたたびさきほどの表に向きあうと</p>
<p><img src="hilbert-x.svg"></p>
<p><img src="hilbert-y.svg"></p>
<p>　ちょうど表の ½ の地点で縦横に分割するときれいに分かれます。さらに都合のよいことにこの曲線を直線になおしたとき、それぞれ ¼, ½, ¾ の位置になります。つまり x に基づいた探索では直線の ½ の位置を基準にし、 y に基づいた探索では直線の ¼, ¾ の位置を基準に探索すればよさそうです。さらにこれは再帰的に繰り返されます。なお途中で x と y の向きが変わる場合がありますので、それをシアンとマゼンタで塗り分けました。</p>
<p><img src="hilbert-z.svg"></p>
<p>　表の x または y が与えられたとき、直線の区間 [p, q] に x や y を通過する点が存在するかを判定できればよさそうです。たとえば表の左上を (0, 0) 右下を (1, 1) とし、また直線も左上の端点が 0 右上の端点が 1 とすれば、 x = ¼ ならば [½, ¾] の区間は探索しなくてもよいと即座に判定できます。（※ ただし表も直線もそれぞれ座標がとりうる値は [0, 1)² および [0, 1) というふうに右端の端点を含まないことに注意）</p>
<p>　この直観をコードになおすと以下のようになります。</p>
<pre><code><span class="nf">vertical</span> <span class="ow">::</span> <span class="kt">Integral</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
<span class="nf">vertical</span> <span class="n">n</span> <span class="n">x</span> <span class="n">p</span> <span class="n">q</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;n must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;x must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;x must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="n">n</span><span class="p">))</span> <span class="o">/=</span> <span class="mi">1</span>                 <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator x must be a divisor of 2^n.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/=</span> <span class="mi">1</span>             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator p must be a divisor of 2^(n*2).&quot;</span>
  <span class="o">|</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;q must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;q must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">q</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/=</span> <span class="mi">1</span>             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator q must be a divisor of 2^(n*2).&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&gt;</span>  <span class="n">q</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be less than or equal to q.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>                   <span class="ow">=</span> <span class="kt">True</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span>                                           <span class="ow">=</span> <span class="kt">True</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span>     <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                    <span class="o">||</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span>     <span class="ow">=</span> <span class="kt">False</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="kt">False</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span>     <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
                                                    <span class="o">||</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
  <span class="kr">where</span> <span class="n">m</span> <span class="ow">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="ow">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</code></pre>
<pre><code><span class="nf">horizontal</span> <span class="ow">::</span> <span class="kt">Integral</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
<span class="nf">horizontal</span> <span class="n">n</span> <span class="n">y</span> <span class="n">p</span> <span class="n">q</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;n must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;y must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;y must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="n">n</span><span class="p">))</span> <span class="o">/=</span> <span class="mi">1</span>                 <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator y must be a divisor of 2^n.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/=</span> <span class="mi">1</span>             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator p must be a divisor of 2^(n*2).&quot;</span>
  <span class="o">|</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;q must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;q must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">q</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/=</span> <span class="mi">1</span>             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator q must be a divisor of 2^(n*2).&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&gt;</span>  <span class="n">q</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be less than or equal to q.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>                   <span class="ow">=</span> <span class="kt">True</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span>                                           <span class="ow">=</span> <span class="kt">True</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="kt">False</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span>     <span class="ow">=</span> <span class="kt">False</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="kt">False</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span>     <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                    <span class="o">||</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">0</span>     <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&lt;</span>  <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                    <span class="o">||</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
  <span class="kr">where</span> <span class="n">m</span> <span class="ow">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="ow">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</code></pre>
<h2>二分探索木に応用してみる</h2>
<p>　さてこれで二分探索におけるいろいろなアルゴリズムやデータ構造が利用可能になりました。平衡二分探索木にするなどはまた別途するとして、素朴な二分探索木が動作するかを確かめてみます。</p>
<pre><code><span class="kr">class</span> <span class="kt">Hash8</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="n">hash8</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Word</span><span class="o">.</span><span class="kt">Word8</span>

<span class="kr">instance</span> <span class="kt">Hash8</span> <span class="kt">Int</span><span class="o">.</span><span class="kt">Int8</span> <span class="kr">where</span>
  <span class="n">hash8</span> <span class="ow">=</span> <span class="n">fromIntegral</span>

<span class="kr">instance</span> <span class="kt">Hash8</span> <span class="kt">Word</span><span class="o">.</span><span class="kt">Word8</span> <span class="kr">where</span>
  <span class="n">hash8</span> <span class="ow">=</span> <span class="n">id</span>

<span class="kr">data</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span>
    <span class="kt">Leaf</span>
  <span class="o">|</span> <span class="kt">Branch</span>
      <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span>
      <span class="p">(</span><span class="kt">Ratio</span> <span class="kt">Int</span><span class="o">.</span><span class="kt">Int64</span><span class="p">)</span>
      <span class="p">(</span><span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span>
      <span class="p">(</span><span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">,</span> <span class="kt">Read</span><span class="p">,</span> <span class="kt">Show</span><span class="p">)</span>

<span class="nf">hash</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Hash8</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Hash8</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="kt">Int</span><span class="o">.</span><span class="kt">Int64</span>
<span class="nf">hash</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span>
  <span class="n">curve</span> <span class="mi">8</span>
    <span class="p">(</span><span class="n">fromIntegral</span> <span class="p">(</span><span class="n">hash8</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">8</span><span class="p">)</span>
    <span class="p">(</span><span class="n">fromIntegral</span> <span class="p">(</span><span class="n">hash8</span> <span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">8</span><span class="p">)</span>

<span class="nf">empty</span> <span class="ow">::</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span>
<span class="nf">empty</span> <span class="ow">=</span>
  <span class="kt">Leaf</span>

<span class="nf">singleton</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Hash8</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Hash8</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span>
<span class="nf">singleton</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span>
  <span class="kt">Branch</span>
    <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span>
    <span class="p">(</span><span class="n">hash</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span>
    <span class="kt">Leaf</span>
    <span class="kt">Leaf</span>

<span class="nf">insert</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Hash8</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Hash8</span> <span class="n">b</span><span class="p">,</span> <span class="kt">Ord</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Ord</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span>
<span class="nf">insert</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span> <span class="n">insert&#39;</span> <span class="p">(</span><span class="n">hash</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span> <span class="kr">where</span>
  <span class="n">insert&#39;</span> <span class="n">p</span> <span class="kt">Leaf</span> <span class="ow">=</span>
    <span class="kt">Branch</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span> <span class="n">p</span> <span class="kt">Leaf</span> <span class="kt">Leaf</span>
  <span class="n">insert&#39;</span> <span class="n">p</span> <span class="p">(</span><span class="kt">Branch</span> <span class="n">xys</span> <span class="n">q</span> <span class="n">l</span> <span class="n">r</span><span class="p">)</span> <span class="ow">=</span>
    <span class="kr">case</span> <span class="n">compare</span> <span class="n">p</span> <span class="n">q</span> <span class="kr">of</span>
      <span class="kt">LT</span> <span class="ow">-&gt;</span> <span class="kt">Branch</span> <span class="n">xys</span> <span class="n">q</span> <span class="p">(</span><span class="n">insert&#39;</span> <span class="n">p</span> <span class="n">l</span><span class="p">)</span> <span class="n">r</span>
      <span class="kt">EQ</span> <span class="ow">-&gt;</span> <span class="kt">Branch</span> <span class="p">(</span><span class="kt">List</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="n">xys</span><span class="p">)</span> <span class="n">q</span> <span class="n">l</span> <span class="n">r</span>
      <span class="kt">GT</span> <span class="ow">-&gt;</span> <span class="kt">Branch</span> <span class="n">xys</span> <span class="n">q</span> <span class="n">l</span> <span class="p">(</span><span class="n">insert&#39;</span> <span class="n">p</span> <span class="n">r</span><span class="p">)</span>

<span class="nf">lookupX</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Hash8</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Ord</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span>
<span class="nf">lookupX</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">x</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">lookupX&#39;</span> <span class="mi">0</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">)</span> <span class="n">x</span> <span class="n">r</span> <span class="kt">[]</span> <span class="kr">where</span>
  <span class="n">lookupX&#39;</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kt">Leaf</span> <span class="ow">=</span>
    <span class="n">id</span>
  <span class="n">lookupX&#39;</span> <span class="n">p</span> <span class="n">q</span> <span class="n">x</span> <span class="p">(</span><span class="kt">Branch</span> <span class="n">xys</span> <span class="n">z</span> <span class="n">l</span> <span class="n">r</span><span class="p">)</span> <span class="ow">=</span>
    <span class="kr">if</span> <span class="n">vertical</span> <span class="mi">8</span> <span class="p">(</span><span class="n">fromIntegral</span> <span class="p">(</span><span class="n">hash8</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">8</span> <span class="ow">::</span> <span class="kt">Ratio</span> <span class="kt">Int</span><span class="o">.</span><span class="kt">Int64</span><span class="p">)</span> <span class="n">p</span> <span class="n">q</span> <span class="kr">then</span>
      <span class="n">lookupX&#39;</span> <span class="n">p</span> <span class="p">(</span><span class="n">max</span> <span class="n">p</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">))</span> <span class="n">x</span> <span class="n">l</span>
        <span class="o">.</span> <span class="p">((</span><span class="n">map</span> <span class="n">snd</span> <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="nf">\</span><span class="n">xy</span> <span class="ow">-&gt;</span> <span class="n">x</span> <span class="o">==</span> <span class="n">fst</span> <span class="n">xy</span><span class="p">)</span> <span class="n">xys</span><span class="p">))</span> <span class="o">++</span> <span class="p">)</span>
        <span class="o">.</span> <span class="n">lookupX&#39;</span> <span class="p">(</span><span class="n">min</span> <span class="n">q</span> <span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">))</span> <span class="n">q</span> <span class="n">x</span> <span class="n">r</span>
    <span class="kr">else</span>
      <span class="n">id</span>

<span class="nf">lookupY</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Hash8</span> <span class="n">b</span><span class="p">,</span> <span class="kt">Ord</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="nf">lookupY</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">x</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">lookupY&#39;</span> <span class="mi">0</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">)</span> <span class="n">x</span> <span class="n">r</span> <span class="kt">[]</span> <span class="kr">where</span>
  <span class="n">lookupY&#39;</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kt">Leaf</span> <span class="ow">=</span>
    <span class="n">id</span>
  <span class="n">lookupY&#39;</span> <span class="n">p</span> <span class="n">q</span> <span class="n">y</span> <span class="p">(</span><span class="kt">Branch</span> <span class="n">xys</span> <span class="n">z</span> <span class="n">l</span> <span class="n">r</span><span class="p">)</span> <span class="ow">=</span>
    <span class="kr">if</span> <span class="n">horizontal</span> <span class="mi">8</span> <span class="p">(</span><span class="n">fromIntegral</span> <span class="p">(</span><span class="n">hash8</span> <span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">8</span> <span class="ow">::</span> <span class="kt">Ratio</span> <span class="kt">Int</span><span class="o">.</span><span class="kt">Int64</span><span class="p">)</span> <span class="n">p</span> <span class="n">q</span> <span class="kr">then</span>
      <span class="n">lookupY&#39;</span> <span class="n">p</span> <span class="p">(</span><span class="n">max</span> <span class="n">p</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">))</span> <span class="n">y</span> <span class="n">l</span>
        <span class="o">.</span> <span class="p">(</span><span class="n">map</span> <span class="n">fst</span> <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="nf">\</span><span class="n">xy</span> <span class="ow">-&gt;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">snd</span> <span class="n">xy</span><span class="p">)</span> <span class="n">xys</span><span class="p">)</span> <span class="o">++</span><span class="p">)</span>
        <span class="o">.</span> <span class="n">lookupY&#39;</span> <span class="p">(</span><span class="n">min</span> <span class="n">q</span> <span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">))</span> <span class="n">q</span> <span class="n">y</span> <span class="n">r</span>
    <span class="kr">else</span>
      <span class="n">id</span>
</code></pre>
<h3>動作確認</h3>
<p>GHCi で動作確認をしてみます。今回はわかりやすい例として square(x)=x² を考えます。 sqrt(x)=√x として square⁻¹=sqrt です。たとえば square(4)=16 で sqrt(16)=4 です。</p>
<pre><code>> :set +m
> let square :: Relation Int.Int8 Int.Int8
|     square = insert 4 16 (insert 3 9 (insert 0 0 (insert 1 1 (singleton 2 4))))
|
> print square
Branch [(2,4)] (27 % 32768) (Branch [(1,1)] (1 % 32768) (Branch [(0,0)] (0 % 1) Leaf Leaf) Leaf) (Branch [(3,9)] (35 % 32768) Leaf (Branch [(4,16)] (461 % 32768) Leaf Leaf))
> lookupX 0 square
[0]
> lookupX 1 square
[1]
> lookupX 2 square
[4]
> lookupX 3 square
[9]
> lookupX 4 square
[16]
> lookupY 0 square
[0]
> lookupY 1 square
[1]
> lookupY 4 square
[2]
> lookupY 9 square
[3]
> lookupY 16 square
[4]
</code></pre>
    </article>
  </div>
  <div class="bottom right layer" data-width="full" data-height="1">
    <nav class="horizontal component" data-route="/note/tree-of-hilbert-curve/" data-routes="/note/tree-of-hilbert-curve/appendix/" data-loaded="true" data-scrollbar="none" data-visible="true">
<a class="component" href="/" data-route="/" data-focus="false" data-focus-within="false">&#x221A;</a><a class="component" href="/note/" data-route="/note/" data-focus="false" data-focus-within="false">Note</a><a class="component" href="/note/tree-of-hilbert-curve/" data-route="/note/tree-of-hilbert-curve/" data-focus="true" data-focus-within="false">ヒルベルト曲線を用いた二分探索木について</a><a class="component" href="/note/tree-of-hilbert-curve/appendix/" data-route="/note/tree-of-hilbert-curve/appendix/" data-focus="false" data-focus-within="false">Appendix</a>    </nav>
  </div>
</div>
