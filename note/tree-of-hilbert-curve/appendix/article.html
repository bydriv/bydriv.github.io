<h1>Appendix</h1>
<h2>Relation.hs</h2>
<pre><code><span class="kr">module</span> <span class="nn">Relation</span>
  <span class="p">(</span> <span class="kt">Hash8</span><span class="p">(</span><span class="nf">hash8</span><span class="p">)</span>
  <span class="p">,</span> <span class="kt">Relation</span>
  <span class="p">,</span> <span class="nf">curve</span><span class="p">,</span> <span class="nf">vertical</span><span class="p">,</span> <span class="nf">horizontal</span>
  <span class="p">,</span> <span class="nf">empty</span><span class="p">,</span> <span class="nf">singleton</span>
  <span class="p">,</span> <span class="nf">insert</span><span class="p">,</span> <span class="nf">lookupX</span><span class="p">,</span> <span class="nf">lookupY</span> <span class="p">)</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Int</span>  <span class="k">as</span> <span class="n">Int</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Word</span> <span class="k">as</span> <span class="n">Word</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.List</span> <span class="k">as</span> <span class="n">List</span>
<span class="kr">import</span>           <span class="nn">Data.Ratio</span> <span class="p">(</span><span class="kt">Ratio</span><span class="p">,</span> <span class="p">(</span><span class="o">%</span><span class="p">),</span> <span class="nf">denominator</span><span class="p">)</span>

<span class="kr">class</span> <span class="kt">Hash8</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="n">hash8</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Word</span><span class="o">.</span><span class="kt">Word8</span>

<span class="kr">instance</span> <span class="kt">Hash8</span> <span class="kt">Int</span><span class="o">.</span><span class="kt">Int8</span> <span class="kr">where</span>
  <span class="n">hash8</span> <span class="ow">=</span> <span class="n">fromIntegral</span>

<span class="kr">instance</span> <span class="kt">Hash8</span> <span class="kt">Word</span><span class="o">.</span><span class="kt">Word8</span> <span class="kr">where</span>
  <span class="n">hash8</span> <span class="ow">=</span> <span class="n">id</span>

<span class="kr">data</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span>
    <span class="kt">Leaf</span>
  <span class="o">|</span> <span class="kt">Branch</span>
      <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span>
      <span class="p">(</span><span class="kt">Ratio</span> <span class="kt">Int</span><span class="o">.</span><span class="kt">Int64</span><span class="p">)</span>
      <span class="p">(</span><span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span>
      <span class="p">(</span><span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">,</span> <span class="kt">Read</span><span class="p">,</span> <span class="kt">Show</span><span class="p">)</span>

<span class="nf">curve</span> <span class="ow">::</span> <span class="kt">Integral</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span>
<span class="nf">curve</span> <span class="n">n</span> <span class="n">x</span> <span class="n">y</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span>  <span class="mi">0</span>                             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;n must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">0</span>                             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;x must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span>                             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;x must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="n">n</span><span class="p">))</span> <span class="o">/=</span> <span class="mi">1</span>   <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator x must be a divisor of 2^n.&quot;</span>
  <span class="o">|</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">0</span>                             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;y must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span>                             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;y must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="n">n</span><span class="p">))</span> <span class="o">/=</span> <span class="mi">1</span>   <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator y must be a divisor of 2^n.&quot;</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span>                             <span class="ow">=</span> <span class="mi">0</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">curve</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>     <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>           <span class="o">/</span> <span class="mi">4</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">curve</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>     <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>       <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">curve</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">curve</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>       <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">%</span> <span class="mi">4</span>
  <span class="kr">where</span> <span class="n">m</span> <span class="ow">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="nf">vertical</span> <span class="ow">::</span> <span class="kt">Integral</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
<span class="nf">vertical</span> <span class="n">n</span> <span class="n">x</span> <span class="n">p</span> <span class="n">q</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;n must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;x must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;x must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="n">n</span><span class="p">))</span> <span class="o">/=</span> <span class="mi">1</span>                 <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator x must be a divisor of 2^n.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/=</span> <span class="mi">1</span>             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator p must be a divisor of 2^(n*2).&quot;</span>
  <span class="o">|</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;q must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;q must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">q</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/=</span> <span class="mi">1</span>             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator q must be a divisor of 2^(n*2).&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&gt;</span>  <span class="n">q</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be less than or equal to q.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>                   <span class="ow">=</span> <span class="kt">True</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span>                                           <span class="ow">=</span> <span class="kt">True</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span>     <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                    <span class="o">||</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span>     <span class="ow">=</span> <span class="kt">False</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="kt">False</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span>     <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
                                                    <span class="o">||</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
  <span class="kr">where</span> <span class="n">m</span> <span class="ow">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="ow">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

<span class="nf">horizontal</span> <span class="ow">::</span> <span class="kt">Integral</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
<span class="nf">horizontal</span> <span class="n">n</span> <span class="n">y</span> <span class="n">p</span> <span class="n">q</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;n must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;y must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;y must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="n">n</span><span class="p">))</span> <span class="o">/=</span>                   <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator y must be a divisor of 2^n.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/=</span> <span class="mi">1</span>             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator p must be a divisor of 2^(n*2).&quot;</span>
  <span class="o">|</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">0</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;q must be greater than or equal to 0.&quot;</span>
  <span class="o">|</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">1</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;q must be less than 1.&quot;</span>
  <span class="o">|</span> <span class="n">denominator</span> <span class="p">(</span><span class="n">q</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/=</span> <span class="mi">1</span>             <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;denominator q must be a divisor of 2^(n*2).&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">&gt;</span>  <span class="n">q</span>                                           <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;p must be less than or equal to q.&quot;</span>
  <span class="o">|</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>                   <span class="ow">=</span> <span class="kt">True</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span>                                           <span class="ow">=</span> <span class="kt">True</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="kt">False</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span>     <span class="ow">=</span> <span class="kt">False</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="kt">False</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span>     <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span>
                                                    <span class="o">||</span> <span class="n">vertical</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&lt;</span>  <span class="mi">0</span>     <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
  <span class="o">|</span> <span class="n">n</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&lt;</span>  <span class="mi">3</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">q</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">4</span> <span class="ow">=</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                    <span class="o">||</span> <span class="n">horizontal</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">m</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
                                                         <span class="p">(</span><span class="n">max</span> <span class="mi">0</span> <span class="p">(</span><span class="n">min</span> <span class="n">r</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
  <span class="kr">where</span> <span class="n">m</span> <span class="ow">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="ow">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="p">((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

<span class="nf">hash</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Hash8</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Hash8</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Ratio</span> <span class="kt">Int</span><span class="o">.</span><span class="kt">Int64</span>
<span class="nf">hash</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span>
  <span class="n">curve</span> <span class="mi">8</span>
    <span class="p">(</span><span class="n">fromIntegral</span> <span class="p">(</span><span class="n">hash8</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">8</span><span class="p">)</span>
    <span class="p">(</span><span class="n">fromIntegral</span> <span class="p">(</span><span class="n">hash8</span> <span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">8</span><span class="p">)</span>

<span class="nf">empty</span> <span class="ow">::</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span>
<span class="nf">empty</span> <span class="ow">=</span>
  <span class="kt">Leaf</span>

<span class="nf">singleton</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Hash8</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Hash8</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span>
<span class="nf">singleton</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span>
  <span class="kt">Branch</span>
    <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span>
    <span class="p">(</span><span class="n">hash</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span>
    <span class="kt">Leaf</span>
    <span class="kt">Leaf</span>

<span class="nf">insert</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Hash8</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Hash8</span> <span class="n">b</span><span class="p">,</span> <span class="kt">Ord</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Ord</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span>
<span class="nf">insert</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span> <span class="n">insert&#39;</span> <span class="p">(</span><span class="n">hash</span> <span class="n">x</span> <span class="n">y</span><span class="p">)</span> <span class="kr">where</span>
  <span class="n">insert&#39;</span> <span class="n">p</span> <span class="kt">Leaf</span> <span class="ow">=</span>
    <span class="kt">Branch</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span> <span class="n">p</span> <span class="kt">Leaf</span> <span class="kt">Leaf</span>
  <span class="n">insert&#39;</span> <span class="n">p</span> <span class="p">(</span><span class="kt">Branch</span> <span class="n">xys</span> <span class="n">q</span> <span class="n">l</span> <span class="n">r</span><span class="p">)</span> <span class="ow">=</span>
    <span class="kr">case</span> <span class="n">compare</span> <span class="n">p</span> <span class="n">q</span> <span class="kr">of</span>
      <span class="kt">LT</span> <span class="ow">-&gt;</span> <span class="kt">Branch</span> <span class="n">xys</span> <span class="n">q</span> <span class="p">(</span><span class="n">insert&#39;</span> <span class="n">p</span> <span class="n">l</span><span class="p">)</span> <span class="n">r</span>
      <span class="kt">EQ</span> <span class="ow">-&gt;</span> <span class="kt">Branch</span> <span class="p">(</span><span class="kt">List</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="n">xys</span><span class="p">)</span> <span class="n">q</span> <span class="n">l</span> <span class="n">r</span>
      <span class="kt">GT</span> <span class="ow">-&gt;</span> <span class="kt">Branch</span> <span class="n">xys</span> <span class="n">q</span> <span class="n">l</span> <span class="p">(</span><span class="n">insert&#39;</span> <span class="n">p</span> <span class="n">r</span><span class="p">)</span>

<span class="nf">lookupX</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Hash8</span> <span class="n">a</span><span class="p">,</span> <span class="kt">Ord</span> <span class="n">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span>
<span class="nf">lookupX</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">x</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">lookupX&#39;</span> <span class="mi">0</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">)</span> <span class="n">x</span> <span class="n">r</span> <span class="kt">[]</span> <span class="kr">where</span>
  <span class="n">lookupX&#39;</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kt">Leaf</span> <span class="ow">=</span>
    <span class="n">id</span>
  <span class="n">lookupX&#39;</span> <span class="n">p</span> <span class="n">q</span> <span class="n">x</span> <span class="p">(</span><span class="kt">Branch</span> <span class="n">xys</span> <span class="n">z</span> <span class="n">l</span> <span class="n">r</span><span class="p">)</span> <span class="ow">=</span>
    <span class="kr">if</span> <span class="n">vertical</span> <span class="mi">8</span> <span class="p">(</span><span class="n">fromIntegral</span> <span class="p">(</span><span class="n">hash8</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">8</span> <span class="ow">::</span> <span class="kt">Ratio</span> <span class="kt">Int</span><span class="o">.</span><span class="kt">Int64</span><span class="p">)</span> <span class="n">p</span> <span class="n">q</span> <span class="kr">then</span>
      <span class="n">lookupX&#39;</span> <span class="n">p</span> <span class="p">(</span><span class="n">max</span> <span class="n">p</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">))</span> <span class="n">x</span> <span class="n">l</span>
        <span class="o">.</span> <span class="p">((</span><span class="n">map</span> <span class="n">snd</span> <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="nf">\</span><span class="n">xy</span> <span class="ow">-&gt;</span> <span class="n">x</span> <span class="o">==</span> <span class="n">fst</span> <span class="n">xy</span><span class="p">)</span> <span class="n">xys</span><span class="p">))</span> <span class="o">++</span> <span class="p">)</span>
        <span class="o">.</span> <span class="n">lookupX&#39;</span> <span class="p">(</span><span class="n">min</span> <span class="n">q</span> <span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">))</span> <span class="n">q</span> <span class="n">x</span> <span class="n">r</span>
    <span class="kr">else</span>
      <span class="n">id</span>

<span class="nf">lookupY</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Hash8</span> <span class="n">b</span><span class="p">,</span> <span class="kt">Ord</span> <span class="n">b</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Relation</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="nf">lookupY</span> <span class="ow">=</span> <span class="nf">\</span><span class="n">x</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">lookupY&#39;</span> <span class="mi">0</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">)</span> <span class="n">x</span> <span class="n">r</span> <span class="kt">[]</span> <span class="kr">where</span>
  <span class="n">lookupY&#39;</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kt">Leaf</span> <span class="ow">=</span>
    <span class="n">id</span>
  <span class="n">lookupY&#39;</span> <span class="n">p</span> <span class="n">q</span> <span class="n">y</span> <span class="p">(</span><span class="kt">Branch</span> <span class="n">xys</span> <span class="n">z</span> <span class="n">l</span> <span class="n">r</span><span class="p">)</span> <span class="ow">=</span>
    <span class="kr">if</span> <span class="n">horizontal</span> <span class="mi">8</span> <span class="p">(</span><span class="n">fromIntegral</span> <span class="p">(</span><span class="n">hash8</span> <span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">8</span> <span class="ow">::</span> <span class="kt">Ratio</span> <span class="kt">Int</span><span class="o">.</span><span class="kt">Int64</span><span class="p">)</span> <span class="n">p</span> <span class="n">q</span> <span class="kr">then</span>
      <span class="n">lookupY&#39;</span> <span class="n">p</span> <span class="p">(</span><span class="n">max</span> <span class="n">p</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">))</span> <span class="n">y</span> <span class="n">l</span>
        <span class="o">.</span> <span class="p">(</span><span class="n">map</span> <span class="n">fst</span> <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="nf">\</span><span class="n">xy</span> <span class="ow">-&gt;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">snd</span> <span class="n">xy</span><span class="p">)</span> <span class="n">xys</span><span class="p">)</span> <span class="o">++</span><span class="p">)</span>
        <span class="o">.</span> <span class="n">lookupY&#39;</span> <span class="p">(</span><span class="n">min</span> <span class="n">q</span> <span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">2</span><span class="o">^</span><span class="mi">16</span><span class="p">))</span> <span class="n">q</span> <span class="n">y</span> <span class="n">r</span>
    <span class="kr">else</span>
      <span class="n">id</span>
</code></pre>
