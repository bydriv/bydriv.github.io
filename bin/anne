#!/usr/bin/runhaskell -isrc

import qualified Data.Anne as Anne
import qualified Data.List as List

escape :: String -> String
escape [] = []
escape ('"':s) = '\\' : '"' : escape s
escape ('\\':s) = '\\' : '\\' : escape s
escape ('/':s) = '\\' : '/' : escape s
escape ('\b':s) = '\\' : 'b' : escape s
escape ('\f':s) = '\\' : 'f' : escape s
escape ('\n':s) = '\\' : 'n' : escape s
escape ('\r':s) = '\\' : 'r' : escape s
escape ('\t':s) = '\\' : 't' : escape s
escape (c:s) = c : escape s

list :: [String] -> String
list ss = concat (["["] ++ List.intersperse "," ss ++ ["]"])

toJSON :: Anne.Anne -> String
toJSON (Anne.Anne anne) = list (map (list . map datumToJSON) anne)

datumToJSON :: Anne.Datum -> String
datumToJSON (Anne.Atom (Anne.String _ s)) = "\"" ++ escape s ++ "\""
datumToJSON (Anne.List dat) = list (map datumToJSON dat)

main :: IO ()
main = do
  s <- getContents

  case Anne.lex s of
    Right ts ->
      case Anne.parse ts of
        Right a ->
          putStrLn (toJSON a)
        Left e ->
          case e of
            Anne.UnexpectedEOF ->
              putStrLn "unexpected eof"
            Anne.UnexpectedChar (p, c) ->
              putStrLn "unexpected char"
            Anne.UnexpectedToken (Anne.Token t p s) ->
              putStrLn "unexpected token"
    Left e ->
      case e of
        Anne.UnexpectedEOF ->
          putStrLn "unexpected eof"
        Anne.UnexpectedChar (p, c) ->
          putStrLn "unexpected char"
        Anne.UnexpectedToken (Anne.Token t p s) ->
          putStrLn "unexpected token"
