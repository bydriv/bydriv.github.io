<!DOCTYPE html>
<meta charset="utf-8">
<script>
  window.addEventListener("load", function () {
    var SCALE = 8;

    const mode = document.getElementById("mode");

    var recording = false;
    var recorder = null;

    var canvas = document.getElementById("canvas");
    var context = canvas.getContext("2d");

    fetch("example.png", {cache: "no-cache"}).then(function (r) {
      return r.blob();
    }).then(function (b) {
      return URL.createObjectURL(b);
    }).then(function (url) {
      return new Promise(function (resolve, reject) {
        var img = new Image();
        img.onload = function () {
          resolve(img);
        };
        img.onerror = reject;
        img.src = url;
      });
    }).then(function (img) {
      context.drawImage(img, 0, 0);
    }).then(function () {
      requestAnimationFrame(step);
    });

    function step() {
      if (!recording && mode["record-mode"].checked) {
          const canvasStream = canvas.captureStream();
          recorder = new MediaRecorder(canvasStream);
          const chunks = [];

          recorder.addEventListener("dataavailable", function (e) {
              chunks.push(e.data);
          });

          recorder.addEventListener("stop", function () {
            const blob = new Blob(chunks, {"type": "video/mpeg"});
            const url = URL.createObjectURL(blob);
            const video = document.createElement("video");
            video.src = url;
            video.controls = true;
            const a = document.createElement("a");
            const text = document.createTextNode("download");
            a.href = url;
            a.appendChild(text);
            document.querySelector("#downloads").appendChild(video);
            document.querySelector("#downloads").appendChild(a);
            recorder = null;
          });

          recorder.start();
          recording = true;
      }

      if (recording && !mode["record-mode"].checked) {
          recorder.stop();
          recording = false;
      }

      var w = canvas.width;
      var h = canvas.height;
      var d = context.getImageData(0, 0, w, h);
      var e = context.createImageData(w, h);

      for (var i = 0; i < Math.floor(w / SCALE); ++i) {
        for (var j = 0; j < Math.floor(h / SCALE); ++j) {
          var r = d.data[(i * SCALE + j * w * SCALE) * 4];
          var g = d.data[(i * SCALE + j * w * SCALE) * 4 + 1];
          var b = d.data[(i * SCALE + j * w * SCALE) * 4 + 2];
          var a = d.data[(i * SCALE + j * w * SCALE) * 4 + 3];

          switch (type(r, g, b, a)) {
          case 0:
            for (var k = 0; k < SCALE; ++k) {
              for (var l = 0; l < SCALE; ++l) {
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4] = r;
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 1] = g;
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 2] = b;
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 3] = a;
              }
            }
            break;
          case 1: {
            var k = 0;

            if (neighbor(d, i + 1, j) === 2)
              ++k;
            if (neighbor(d, i + 1, j + 1) === 2)
              ++k;
            if (neighbor(d, i, j + 1) === 2)
              ++k;
            if (neighbor(d, i - 1, j + 1) === 2)
              ++k;
            if (neighbor(d, i - 1, j) === 2)
              ++k;
            if (neighbor(d, i - 1, j - 1) === 2)
              ++k;
            if (neighbor(d, i, j - 1) === 2)
              ++k;
            if (neighbor(d, i + 1, j - 1) === 2)
              ++k;

            if (k === 1 || k === 2) {
              for (var k = 0; k < SCALE; ++k) {
                for (var l = 0; l < SCALE; ++l) {
                  e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4] = 0x00;
                  e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 1] = 0x00;
                  e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 2] = 0xFF;
                  e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 3] = 0xFF;
                }
              }
            } else {
              for (var k = 0; k < SCALE; ++k) {
                for (var l = 0; l < SCALE; ++l) {
                  e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4] = 0xFF;
                  e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 1] = 0xFF;
                  e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 2] = 0x00;
                  e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 3] = 0xFF;
                }
              }
            }
            break;
          }
          case 2:
            for (var k = 0; k < SCALE; ++k) {
              for (var l = 0; l < SCALE; ++l) {
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4] = 0xFF;
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 1] = 0x00;
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 2] = 0x00;
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 3] = 0xFF;
              }
            }
            break;
          case 3:
            for (var k = 0; k < SCALE; ++k) {
              for (var l = 0; l < SCALE; ++l) {
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4] = 0xFF;
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 1] = 0xFF;
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 2] = 0x00;
                e.data[(i * SCALE + k + j * w * SCALE + l * w) * 4 + 3] = 0xFF;
              }
            }
            break;
          }
        }
      }

      context.putImageData(e, 0, 0);

      setTimeout(function () {
        requestAnimationFrame(step)
      }, 100); // 10 fps
    };

    function type(r, g, b, a) {
      if (r === 0xFF && g === 0xFF && b === 0x00 && a === 0xFF) {
        return 1;
      } else if (r === 0x00 && g === 0x00 && b === 0xFF && a === 0xFF) {
        return 2;
      } else if (r === 0xFF && g === 0x00 && b === 0x00 && a === 0xFF) {
        return 3;
      } else {
        return 0;
      }
    }

    function neighbor(d, i, j) {
      var w = d.width;
      return type(d.data[(i * SCALE + j * w * SCALE) * 4], d.data[(i * SCALE + j * w * SCALE) * 4 + 1], d.data[(i * SCALE + j * w * SCALE) * 4 + 2], d.data[(i * SCALE + j * w * SCALE) * 4 + 3]);
    }
  });
</script>

<style>
#canvas {
  image-rendering: crisp-edges;
}
</style>

<form id="mode">
  <input type="checkbox" name="record-mode">record</input>
</form>

<canvas id="canvas"></canvas>

<div id="downloads"></div>
